<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Little Lores - Learn to Read</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.2);
            --transition-speed: 0.3s;
        }
        
        body { 
            font-family: 'Comic Sans MS', cursive, sans-serif; 
            background: var(--primary-gradient); 
            min-height: 100vh; 
            color: #333;
            transition: filter 0.3s ease;
        }
        
        body.dark-mode {
            filter: invert(0.9) hue-rotate(180deg);
        }
        
        body.dark-mode img,
        body.dark-mode .user-avatar {
            filter: invert(1) hue-rotate(180deg);
        }
        
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
        }
        
        /* Header Styles */
        .app-header { 
            text-align: center; 
            margin-bottom: 30px; 
            position: relative; 
        }
        
        .app-title { 
            font-size: 2.5rem; 
            color: white; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
            margin-bottom: 10px; 
        }
        
        .app-subtitle { 
            font-size: 1.2rem; 
            color: rgba(255,255,255,0.9); 
            margin-bottom: 20px; 
        }
        
        /* Streak Counter */
        .streak-counter {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 8px 15px;
            color: white;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .streak-flame {
            font-size: 1.2rem;
            animation: flicker 2s infinite;
        }
        
        @keyframes flicker {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* User Header */
        .user-header { 
            position: absolute; 
            top: 0; 
            right: 0; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: white; 
            font-size: 0.9rem; 
        }
        
        .user-avatar { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            border: 2px solid white; 
        }
        
        .settings-menu {
            position: relative;
        }
        
        .settings-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 10px;
            min-width: 150px;
            display: none;
            z-index: 1000;
        }
        
        .settings-dropdown.show {
            display: block;
        }
        
        .settings-option {
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            color: #333;
            font-size: 0.85rem;
        }
        
        .settings-option:hover {
            background: #f0f0f0;
        }
        
        .logout-btn { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 15px; 
            padding: 5px 12px; 
            cursor: pointer; 
            font-size: 0.8rem; 
            transition: all 0.3s ease; 
        }
        
        .logout-btn:hover { 
            background: rgba(255,255,255,0.3); 
        }
        
        /* Navigation */
        .nav-menu { 
            display: flex; 
            gap: 8px; 
            justify-content: center; 
            flex-wrap: wrap; 
            margin-top: 15px; 
        }
        
        .nav-btn { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 2px solid rgba(255,255,255,0.3); 
            border-radius: 20px; 
            padding: 6px 12px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 0.8rem; 
        }
        
        .nav-btn:hover { 
            background: rgba(255,255,255,0.3); 
            transform: translateY(-2px); 
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.4);
            border-color: white;
        }
        
        /* Breadcrumbs */
        .breadcrumbs {
            color: rgba(255,255,255,0.9);
            font-size: 0.85rem;
            margin: 10px 0;
            text-align: center;
        }
        
        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .breadcrumb-item:hover {
            color: white;
        }
        
        /* Cards */
        .card { 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: var(--card-shadow); 
            margin-bottom: 20px; 
            animation: fadeIn 0.6s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
        }
        
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 10px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .story-skeleton {
            height: 150px;
            margin: 10px 0;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Login Screen */
        .login-screen { text-align: center; }
        
        .google-login-btn { 
            background: #4285f4; 
            color: white; 
            border: none; 
            border-radius: 50px; 
            padding: 15px 30px; 
            font-size: 1.1rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .google-login-btn:hover { 
            background: #3367d6; 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        
        /* Grade and Region Selectors */
        .grade-selector, .region-selector { text-align: center; }
        
        .options-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        
        .option-btn { 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); 
            border: none; 
            border-radius: 15px; 
            padding: 20px; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            color: #333; 
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        
        .option-btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
        }
        
        .option-btn.selected { 
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
            border: 3px solid #4ecdc4; 
        }
        
        .option-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .option-btn:active::after {
            width: 300px;
            height: 300px;
        }
        
        /* Stories Grid */
        .stories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #f5f5f5;
            border-radius: 20px;
            padding: 8px 15px;
            max-width: 250px;
        }
        
        .search-input {
            border: none;
            background: none;
            outline: none;
            flex: 1;
            font-size: 0.9rem;
        }
        
        .stories-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        
        .story-card { 
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); 
            border-radius: 15px; 
            padding: 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border: 3px solid transparent;
            position: relative;
        }
        
        .story-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.2); 
            border-color: #ff6b6b; 
        }
        
        .story-card.completed { 
            background: linear-gradient(135deg, #c3f0ca 0%, #b8e6c1 100%); 
        }
        
        .story-card.in-progress {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
        }
        
        .reading-progress-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .story-title { 
            font-size: 1.3rem; 
            font-weight: bold; 
            margin-bottom: 10px; 
            color: #333; 
        }
        
        .story-nation { 
            background: rgba(255,255,255,0.7); 
            padding: 5px 12px; 
            border-radius: 20px; 
            display: inline-block; 
            font-size: 0.9rem; 
            margin-bottom: 10px; 
        }
        
        .story-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #666;
        }
        
        .reading-time {
            background: rgba(255,255,255,0.5);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .story-preview { 
            font-size: 0.9rem; 
            color: #666; 
            line-height: 1.4; 
        }
        
        /* Reading View */
        .reading-view { 
            max-height: 600px; 
            overflow-y: auto;
            position: relative;
        }
        
        .reading-progress-bar {
            position: sticky;
            top: 0;
            background: #e0e0e0;
            height: 4px;
            z-index: 100;
            margin: -30px -30px 20px -30px;
        }
        
        .reading-progress-fill {
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .story-text { 
            font-size: 1.2rem; 
            line-height: 1.8; 
            margin: 20px 0; 
            text-align: justify; 
        }
        
        .reading-controls { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            justify-content: center; 
            margin: 20px 0; 
        }
        
        .control-btn { 
            background: #4ecdc4; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            padding: 10px 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 0.9rem;
            position: relative;
        }
        
        .control-btn:hover { 
            background: #45b7aa; 
            transform: translateY(-2px); 
        }
        
        .control-btn.active {
            background: #27ae60;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .control-btn:hover .tooltip {
            opacity: 1;
        }
        
        /* Progress Bar */
        .progress-bar { 
            background: #e0e0e0; 
            height: 8px; 
            border-radius: 4px; 
            margin: 20px 0; 
            overflow: hidden; 
        }
        
        .progress-fill { 
            background: linear-gradient(90deg, #4ecdc4, #44a08d); 
            height: 100%; 
            transition: width 0.3s ease; 
        }
        
        /* Achievements */
        .achievements-panel {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .achievement-badge {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            opacity: 0.3;
            filter: grayscale(1);
        }
        
        .achievement-badge.earned {
            opacity: 1;
            filter: grayscale(0);
        }
        
        .achievement-badge:hover {
            transform: translateY(-5px);
        }
        
        .achievement-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .achievement-name {
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        /* Back Button */
        .back-btn { 
            background: #95a5a6; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            padding: 10px 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            margin-bottom: 20px; 
        }
        
        .back-btn:hover { 
            background: #7f8c8d; 
        }
        
        /* User Info */
        .user-info { 
            text-align: center; 
            margin-bottom: 20px; 
            color: white; 
        }
        
        /* Utility Classes */
        .hidden { display: none; }
        
        .loading { 
            text-align: center; 
            padding: 20px; 
            color: #666; 
        }
        
        .error { 
            background: #ffe6e6; 
            border: 2px solid #ff6b6b; 
            border-radius: 10px; 
            padding: 15px; 
            margin: 10px 0; 
            color: #d63031; 
        }
        
        .success-message {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #155724;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .reading-assistance { 
            background: #fff3cd; 
            border: 2px solid #ffeaa7; 
            border-radius: 10px; 
            padding: 15px; 
            margin: 10px 0; 
            font-size: 0.9rem; 
        }
        
        .word-help { 
            background: #e3f2fd; 
            padding: 3px 8px; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        
        .word-help:hover { 
            background: #bbdefb; 
        }
        
        /* Font Options */
        .font-dyslexic {
            font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .app-title { font-size: 2rem; }
            .container { padding: 10px; }
            .card { padding: 20px; }
            .options-grid { grid-template-columns: 1fr; }
            .nav-btn { font-size: 0.7rem; padding: 5px 10px; }
            .user-header { 
                position: static; 
                justify-content: center; 
                margin-bottom: 15px; 
            }
            .streak-counter {
                position: static;
                margin-bottom: 10px;
                justify-content: center;
            }
            .stories-header {
                flex-direction: column;
                gap: 15px;
            }
            .search-box {
                max-width: 100%;
            }
        }
        
        /* Keyboard Navigation Highlight */
        .keyboard-focus {
            outline: 3px solid #4ecdc4;
            outline-offset: 2px;
        }
        
        /* Confetti Animation */
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confetti-fall 3s linear;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <div id="streakCounter" class="streak-counter hidden">
                <span class="streak-flame">🔥</span>
                <span id="streakDays">0</span> day streak!
            </div>
            
            <h1 class="app-title">📚 Little Lores</h1>
            <p class="app-subtitle">Discover the world through reading!</p>
            
            <!-- Breadcrumbs -->
            <div id="breadcrumbs" class="breadcrumbs hidden">
                <span class="breadcrumb-item" onclick="navigateHome()">Home</span>
                <span id="breadcrumbPath"></span>
            </div>
            
            <!-- User Info (top right) -->
            <div id="userHeader" class="user-header hidden">
                <img id="userAvatar" class="user-avatar" src="" alt="User">
                <span id="userNameHeader"></span>
                <div class="settings-menu">
                    <button class="settings-btn" onclick="toggleSettings()">⚙️</button>
                    <div id="settingsDropdown" class="settings-dropdown">
                        <div class="settings-option" onclick="toggleDarkMode()">🌙 Dark Mode</div>
                        <div class="settings-option" onclick="toggleDyslexicFont()">📖 Dyslexic Font</div>
                        <div class="settings-option" onclick="showAchievements()">🏆 Achievements</div>
                        <div class="settings-option" onclick="resetProgress()">🔄 Reset Progress</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            
            <!-- Navigation Menu -->
            <div id="navMenu" class="nav-menu hidden">
                <button class="nav-btn" id="navGrade" onclick="showGradeSelect()">📚 Grade</button>
                <button class="nav-btn" id="navRegion" onclick="showRegionSelect()">🗺️ Region</button>
                <button class="nav-btn" id="navStories" onclick="backToStories()">📖 Stories</button>
                <button class="nav-btn" id="navRead" onclick="showStoriesRead()">✅ Read</button>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="card login-screen">
            <h2>Welcome, Young Explorer! 📚</h2>
            <p style="margin: 20px 0;">Let's start your reading adventure around the world!</p>
            <button class="google-login-btn" onclick="handleLogin()">
                <span>🔍</span> Login with Google
            </button>
            <div id="loginError" class="error hidden"></div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="card loading hidden">
            <h2>Loading your stories... 📖</h2>
            <div class="spinner"></div>
            <p>Please wait while we prepare your reading adventure!</p>
        </div>

        <!-- Grade Selection -->
        <div id="gradeScreen" class="card grade-selector hidden">
            <h2>What grade are you in? 🎓</h2>
            <div class="options-grid">
                <button class="option-btn" onclick="selectGrade('K-1')">Kindergarten - 1st Grade</button>
                <button class="option-btn" onclick="selectGrade('2-3')">2nd - 3rd Grade</button>
                <button class="option-btn" onclick="selectGrade('4-5')">4th - 5th Grade</button>
                <button class="option-btn" onclick="selectGrade('6-8')">6th - 8th Grade</button>
            </div>
        </div>

        <!-- Region Selection -->
        <div id="regionScreen" class="card region-selector hidden">
            <div class="user-info">
                <p>Hello, <span id="userName">Student</span>! Grade: <span id="userGrade"></span></p>
            </div>
            <h2>Which part of the world would you like to explore? 🗺️</h2>
            <div class="options-grid">
                <button class="option-btn" onclick="selectRegion('Africa')">🌍 Africa</button>
                <button class="option-btn" onclick="selectRegion('Asia')">🏯 Asia</button>
                <button class="option-btn" onclick="selectRegion('Europe')">🏰 Europe</button>
                <button class="option-btn" onclick="selectRegion('Americas')">🗽 Americas</button>
                <button class="option-btn" onclick="selectRegion('Oceania')">🏝️ Oceania</button>
                <button class="option-btn" onclick="selectRegion('Mixed')">🌈 Surprise Me!</button>
            </div>
        </div>

        <!-- Stories Selection -->
        <div id="storiesScreen" class="card hidden">
            <div class="user-info">
                <p><span id="userNameStories"></span> | Grade: <span id="userGradeStories"></span> | Region: <span id="userRegionStories"></span></p>
            </div>
            
            <div class="stories-header">
                <h2>Choose your next adventure! 📖</h2>
                <div class="search-box hidden" id="searchBox">
                    <span>🔍</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search stories..." onkeyup="filterStories()">
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p style="text-align: center; margin: 10px 0;">
                Stories completed: <span id="completedCount">0</span> | 
                Points: <span id="userPoints">0</span> ⭐
            </p>
            
            <div id="continueReading" class="story-card in-progress hidden" style="margin-bottom: 20px;">
                <div class="reading-progress-indicator">📖</div>
                <div class="story-title">Continue Reading</div>
                <div id="continueTitle"></div>
                <div class="story-meta">
                    <span>Progress: <span id="continueProgress">0</span>%</span>
                    <button class="control-btn" onclick="continueLastStory()">Continue →</button>
                </div>
            </div>
            
            <div class="stories-grid" id="storiesGrid">
                <!-- Stories will be loaded from Supabase -->
            </div>
            
            <div id="storiesLoading" class="hidden">
                <div class="story-skeleton skeleton"></div>
                <div class="story-skeleton skeleton"></div>
                <div class="story-skeleton skeleton"></div>
            </div>
            
            <div id="noStoriesMessage" class="hidden" style="text-align: center; padding: 40px;">
                <h3>📚 No new stories available!</h3>
                <p>You've read all the stories in this region. Try exploring a different region!</p>
            </div>
        </div>

        <!-- Stories Read Screen -->
        <div id="storiesReadScreen" class="card hidden">
            <h2>Stories You've Read! 🎉</h2>
            <div class="user-info" style="color: #333;">
                <p><span id="userNameRead"></span> | Grade: <span id="userGradeRead"></span></p>
            </div>
            
            <div class="search-box" style="margin: 15px auto; max-width: 300px;">
                <span>🔍</span>
                <input type="text" class="search-input" id="searchCompletedInput" placeholder="Search completed stories..." onkeyup="filterCompletedStories()">
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFillRead" style="width: 0%"></div>
            </div>
            <p style="text-align: center; margin: 10px 0;">
                Stories completed: <span id="completedCountRead">0</span> | 
                Total reading time: <span id="totalReadingTime">0</span> minutes
            </p>
            
            <div id="completedStoriesGrid" class="stories-grid">
                <!-- Completed stories will be loaded from Supabase -->
            </div>
            
            <div id="noCompletedStories" class="hidden" style="text-align: center; padding: 40px;">
                <h3>📖 No stories completed yet!</h3>
                <p>Start reading some amazing stories from around the world!</p>
                <button class="control-btn" onclick="backToStories()" style="margin-top: 15px;">Find Stories to Read</button>
            </div>
        </div>

        <!-- Achievements Screen -->
        <div id="achievementsScreen" class="card hidden">
            <button class="back-btn" onclick="backFromAchievements()">← Back</button>
            <h2>Your Achievements 🏆</h2>
            
            <div class="achievements-panel">
                <h3>Reading Milestones</h3>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- Achievements will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="achievements-panel">
                <h3>Your Stats</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #4ecdc4;">
                            <span id="totalStoriesRead">0</span>
                        </div>
                        <div>Stories Read</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #ff6b6b;">
                            <span id="totalPoints">0</span>
                        </div>
                        <div>Points Earned</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #feca57;">
                            <span id="longestStreak">0</span>
                        </div>
                        <div>Longest Streak</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #48dbfb;">
                            <span id="regionsExplored">0</span>/5
                        </div>
                        <div>Regions Explored</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reading View -->
        <div id="readingScreen" class="card hidden">
            <div class="reading-view">
                <div class="reading-progress-bar">
                    <div class="reading-progress-fill" id="readingProgressFill" style="width: 0%"></div>
                </div>
                
                <div class="story-nation" id="currentStoryNation"></div>
                <h2 class="story-title" id="currentStoryTitle"></h2>
                
                <div class="reading-controls">
                    <button class="control-btn" onclick="toggleReadingAssist()">
                        💡 Reading Help
                        <span class="tooltip">Get helpful reading tips</span>
                    </button>
                    <button class="control-btn" id="audioBtn" onclick="toggleAudio()">
                        🔊 Read Aloud
                        <span class="tooltip">Listen to the story</span>
                    </button>
                    <button class="control-btn" id="stopBtn" onclick="stopAudio()" style="display: none;">
                        ⏹️ Stop
                    </button>
                    <button class="control-btn" onclick="adjustSpeed()">
                        ⚡ Speed: <span id="speedDisplay">Normal</span>
                        <span class="tooltip">Change reading speed</span>
                    </button>
                    <button class="control-btn" onclick="adjustTextSize()">
                        🔍 Text Size
                        <span class="tooltip">Make text bigger or smaller</span>
                    </button>
                    <button class="control-btn" id="bookmarkBtn" onclick="toggleBookmark()">
                        🔖 Bookmark
                        <span class="tooltip">Save your place</span>
                    </button>
                </div>

                <div class="reading-assistance hidden" id="readingAssist">
                    <strong>Reading Tips:</strong>
                    <ul style="margin-top: 10px; margin-left: 20px;">
                        <li>Click on highlighted words for help!</li>
                        <li>Take your time - there's no rush</li>
                        <li>Try sounding out difficult words</li>
                        <li>Use the bookmark to save your place</li>
                    </ul>
                </div>

                <div class="story-text" id="currentStoryText" onscroll="updateReadingProgress()"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="control-btn" onclick="completeStory()" style="background: #27ae60; font-size: 1.1rem; padding: 15px 30px;">
                        ✅ I finished reading!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://mxjhvjwjgqmavmasfypa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14amh2andqZ3FtYXZtYXNmeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3Njk5NjEsImV4cCI6MjA2MDM0NTk2MX0.LLk01H7ueKFPMFpZfNOv3zx8VsICu6Gh6msuSjBW2x0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // App State
        let currentUser = null;
        let userGrade = null;
        let userRegion = null;
        let currentStory = null;
        let completedStories = new Set();
        let inProgressStories = new Map(); // story_id -> progress percentage
        let textSizeLevel = 1;
        let allStories = [];
        let userProfile = null;
        let userPoints = 0;
        let userStreak = 0;
        let lastReadDate = null;
        let achievements = new Set();
        let totalReadingTime = 0;
        let currentReadingStartTime = null;
        let bookmarkedPosition = 0;
        
        // Audio controls state
        let currentUtterance = null;
        let isReading = false;
        let isPaused = false;
        let speechRate = 0.8;

        // Screen navigation
        let currentScreen = 'loginScreen';
        const screenHistory = [];
        
        // Settings
        let darkMode = localStorage.getItem('darkMode') === 'true';
        let dyslexicFont = localStorage.getItem('dyslexicFont') === 'true';
        
        // Achievement definitions
        const ACHIEVEMENTS = [
            { id: 'first_story', name: 'First Story', icon: '📖', requirement: 1 },
            { id: 'bookworm', name: 'Bookworm', icon: '📚', requirement: 10 },
            { id: 'scholar', name: 'Scholar', icon: '🎓', requirement: 25 },
            { id: 'world_traveler', name: 'World Traveler', icon: '🌍', requirement: 5, type: 'regions' },
            { id: 'speed_reader', name: 'Speed Reader', icon: '⚡', requirement: 5, type: 'daily' },
            { id: 'week_warrior', name: 'Week Warrior', icon: '🔥', requirement: 7, type: 'streak' },
            { id: 'point_master', name: 'Point Master', icon: '⭐', requirement: 100, type: 'points' }
        ];

        // Initialize settings
        function initializeSettings() {
            if (darkMode) document.body.classList.add('dark-mode');
            if (dyslexicFont) document.body.classList.add('font-dyslexic');
        }

        function showScreen(screenId) {
            // Stop audio when leaving reading screen
            if (currentScreen === 'readingScreen') {
                if (isReading) stopAudio();
                if (currentReadingStartTime) {
                    const readingDuration = (Date.now() - currentReadingStartTime) / 60000; // minutes
                    totalReadingTime += readingDuration;
                    currentReadingStartTime = null;
                }
            }
            
            // Hide all screens with fade effect
            document.querySelectorAll('.card').forEach(card => {
                card.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    card.classList.add('hidden');
                }, 300);
            });
            
            // Show new screen with fade in
            setTimeout(() => {
                const newScreen = document.getElementById(screenId);
                newScreen.classList.remove('hidden');
                newScreen.style.animation = 'fadeIn 0.6s ease-out forwards';
            }, 300);
            
            // Update navigation state
            if (screenId !== currentScreen) {
                screenHistory.push(currentScreen);
            }
            currentScreen = screenId;
            
            // Update nav menu active state
            updateNavActiveState(screenId);
            
            // Update breadcrumbs
            updateBreadcrumbs(screenId);
            
            // Start reading timer if entering reading screen
            if (screenId === 'readingScreen') {
                currentReadingStartTime = Date.now();
            }
        }

        function updateNavActiveState(screenId) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            switch(screenId) {
                case 'gradeScreen':
                    document.getElementById('navGrade')?.classList.add('active');
                    break;
                case 'regionScreen':
                    document.getElementById('navRegion')?.classList.add('active');
                    break;
                case 'storiesScreen':
                    document.getElementById('navStories')?.classList.add('active');
                    break;
                case 'storiesReadScreen':
                    document.getElementById('navRead')?.classList.add('active');
                    break;
            }
        }

        function updateBreadcrumbs(screenId) {
            const breadcrumbs = document.getElementById('breadcrumbs');
            const path = document.getElementById('breadcrumbPath');
            
            if (!currentUser) {
                breadcrumbs.classList.add('hidden');
                return;
            }
            
            breadcrumbs.classList.remove('hidden');
            let pathText = '';
            
            switch(screenId) {
                case 'gradeScreen':
                    pathText = ' > Grade Selection';
                    break;
                case 'regionScreen':
                    pathText = ' > Region Selection';
                    break;
                case 'storiesScreen':
                    pathText = ' > Stories';
                    break;
                case 'storiesReadScreen':
                    pathText = ' > Completed Stories';
                    break;
                case 'readingScreen':
                    pathText = ' > Reading';
                    break;
                case 'achievementsScreen':
                    pathText = ' > Achievements';
                    break;
            }
            
            path.textContent = pathText;
        }

        function navigateHome() {
            if (userGrade && userRegion) {
                backToStories();
            } else if (userGrade) {
                showRegionSelect();
            } else {
                showGradeSelect();
            }
        }

        function showLoading() {
            showScreen('loadingScreen');
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Settings functions
        function toggleSettings() {
            const dropdown = document.getElementById('settingsDropdown');
            dropdown.classList.toggle('show');
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            document.body.classList.toggle('dark-mode');
            toggleSettings();
        }

        function toggleDyslexicFont() {
            dyslexicFont = !dyslexicFont;
            localStorage.setItem('dyslexicFont', dyslexicFont);
            document.body.classList.toggle('font-dyslexic');
            toggleSettings();
        }

        function showAchievements() {
            toggleSettings();
            loadAchievements();
            showScreen('achievementsScreen');
        }

        function backFromAchievements() {
            if (screenHistory.length > 0) {
                showScreen(screenHistory.pop());
            } else {
                backToStories();
            }
        }

        function resetProgress() {
            if (confirm('Are you sure you want to reset all your reading progress? This cannot be undone!')) {
                // Reset local state
                completedStories.clear();
                inProgressStories.clear();
                userPoints = 0;
                achievements.clear();
                totalReadingTime = 0;
                
                // Clear from database
                if (currentUser) {
                    supabase
                        .from('user_progress')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .then(() => {
                            showSuccessMessage('Progress reset successfully!');
                            loadStories();
                        });
                }
            }
            toggleSettings();
        }

        // Streak tracking
        function updateStreak() {
            const today = new Date().toDateString();
            const lastRead = localStorage.getItem(`lastReadDate_${currentUser?.id}`);
            
            if (lastRead) {
                const lastReadDate = new Date(lastRead);
                const daysDiff = Math.floor((new Date() - lastReadDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 0) {
                    // Same day, maintain streak
                } else if (daysDiff === 1) {
                    // Next day, increment streak
                    userStreak++;
                } else {
                    // Streak broken
                    userStreak = 1;
                }
            } else {
                userStreak = 1;
            }
            
            localStorage.setItem(`lastReadDate_${currentUser?.id}`, today);
            localStorage.setItem(`userStreak_${currentUser?.id}`, userStreak);
            
            // Update UI
            if (userStreak > 1) {
                document.getElementById('streakCounter').classList.remove('hidden');
                document.getElementById('streakDays').textContent = userStreak;
            }
        }

        // Authentication
        async function handleLogin() {
            try {
                showLoading();
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname
                    }
                });
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please try again.');
                showScreen('loginScreen');
            }
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                
                // Reset state
                currentUser = null;
                userGrade = null;
                userRegion = null;
                currentStory = null;
                completedStories.clear();
                inProgressStories.clear();
                textSizeLevel = 1;
                allStories = [];
                userProfile = null;
                userPoints = 0;
                achievements.clear();
                
                // Reset audio
                if (isReading) stopAudio();
                
                document.getElementById('navMenu').classList.add('hidden');
                document.getElementById('userHeader').classList.add('hidden');
                document.getElementById('streakCounter').classList.add('hidden');
                screenHistory.length = 0;
                showScreen('loginScreen');
                
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Handle auth state changes
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state change:', event, session?.user?.email);
            
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                
                // Load streak
                userStreak = parseInt(localStorage.getItem(`userStreak_${currentUser.id}`) || '0');
                if (userStreak > 1) {
                    document.getElementById('streakCounter').classList.remove('hidden');
                    document.getElementById('streakDays').textContent = userStreak;
                }
                
                // Show user info and navigation
                document.getElementById('navMenu').classList.remove('hidden');
                document.getElementById('userHeader').classList.remove('hidden');
                document.getElementById('userNameHeader').textContent = currentUser.user_metadata.full_name || currentUser.email;
                document.getElementById('userAvatar').src = currentUser.user_metadata.avatar_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                
                // Load user profile
                await loadUserProfile();
                
                if (userProfile && userProfile.grade) {
                    userGrade = userProfile.grade;
                    userRegion = userProfile.preferred_nation;
                    
                    // Update UI
                    document.getElementById('userName').textContent = currentUser.user_metadata.full_name || currentUser.email;
                    document.getElementById('userGrade').textContent = userGrade;
                    document.getElementById('userGradeStories').textContent = userGrade;
                    
                    if (userRegion) {
                        document.getElementById('userRegionStories').textContent = userRegion;
                        document.getElementById('userNameStories').textContent = currentUser.user_metadata.full_name || currentUser.email;
                        await loadStories();
                        await loadUserProgress();
                        showScreen('storiesScreen');
                    } else {
                        showScreen('regionScreen');
                    }
                } else {
                    document.getElementById('userName').textContent = currentUser.user_metadata.full_name || currentUser.email;
                    showScreen('gradeScreen');
                }
            } else if (event === 'SIGNED_OUT') {
                document.getElementById('userHeader').classList.add('hidden');
                showScreen('loginScreen');
            }
        });

        // User Profile Management
        async function loadUserProfile() {
            try {
                console.log('Loading profile for user:', currentUser.id);
                
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                console.log('Profile query result:', data, error);
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                userProfile = data;
                
                // Load user points from profile
                if (userProfile && userProfile.points) {
                    userPoints = userProfile.points;
                    document.getElementById('userPoints').textContent = userPoints;
                }
                
                console.log('Loaded user profile:', userProfile);
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        async function saveUserProfile() {
            try {
                console.log('Saving profile:', { userGrade, userRegion, userPoints });
                
                const profileData = {
                    user_id: currentUser.id,
                    grade: userGrade,
                    preferred_nation: userRegion,
                    points: userPoints,
                    onboarding_complete: true,
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('user_profiles')
                    .upsert(profileData, { 
                        onConflict: 'user_id',
                        ignoreDuplicates: false 
                    });
                
                console.log('Profile save result:', data, error);
                
                if (error) throw error;
                
                userProfile = { ...profileData };
                console.log('Profile saved successfully');
                
            } catch (error) {
                console.error('Error saving user profile:', error);
            }
        }

        // Navigation functions
        function showGradeSelect() {
            showScreen('gradeScreen');
        }

        function showRegionSelect() {
            showScreen('regionScreen');
        }

        async function showStoriesRead() {
            await loadCompletedStories();
            showScreen('storiesReadScreen');
        }

        function backToStories() {
            if (userRegion) {
                showScreen('storiesScreen');
            } else {
                showScreen('regionScreen');
            }
        }

        // Grade and Region Selection
        async function selectGrade(grade) {
            userGrade = grade;
            document.getElementById('userGrade').textContent = grade;
            document.getElementById('userGradeStories').textContent = grade;
            
            document.querySelectorAll('#gradeScreen .option-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            setTimeout(() => showScreen('regionScreen'), 500);
        }

        async function selectRegion(region) {
            userRegion = region;
            document.getElementById('userRegionStories').textContent = region;
            document.getElementById('userNameStories').textContent = currentUser.user_metadata.full_name || currentUser.email;
            
            document.querySelectorAll('#regionScreen .option-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Save profile
            await saveUserProfile();
            
            setTimeout(async () => {
                showLoading();
                await loadStories();
                await loadUserProgress();
                showScreen('storiesScreen');
            }, 500);
        }

        // Story Management
        async function loadStories() {
            try {
                // Show loading skeletons
                document.getElementById('storiesGrid').style.display = 'none';
                document.getElementById('storiesLoading').classList.remove('hidden');
                
                console.log('Loading stories for region:', userRegion, 'grade:', userGrade);
                
                // Get appropriate grade levels
                const gradeOrder = ['K-1', '2-3', '4-5', '6-8'];
                const userIndex = gradeOrder.indexOf(userGrade);
                let allowedGrades = [userGrade];
                
                if (userIndex >= 0 && userIndex < gradeOrder.length - 1) {
                    allowedGrades.push(gradeOrder[userIndex + 1]);
                }
                
                console.log('Allowed grades:', allowedGrades);
                
                let query = supabase
                    .from('stories_raw')
                    .select('*')
                    .in('grade_level', allowedGrades);
                
                if (userRegion && userRegion !== 'Mixed') {
                    query = query.eq('region', userRegion);
                }
                
                const { data, error } = await query;
                
                console.log('Stories query result:', data, error);
                
                if (error) throw error;
                
                allStories = data || [];
                console.log('Loaded stories:', allStories.length, 'for grades:', allowedGrades);
                
                // Hide loading, show stories
                document.getElementById('storiesLoading').classList.add('hidden');
                document.getElementById('storiesGrid').style.display = 'grid';
                
                displayStories();
                
            } catch (error) {
                console.error('Error loading stories:', error);
                showError('Failed to load stories. Please check your database connection.');
            }
        }

        function displayStories() {
            const storiesGrid = document.getElementById('storiesGrid');
            const noStoriesMessage = document.getElementById('noStoriesMessage');
            storiesGrid.innerHTML = '';
            
            // Filter out completed stories
            const unreadStories = allStories.filter(story => !completedStories.has(story.story_id));
            
            // Check for stories in progress
            const continueReading = document.getElementById('continueReading');
            if (inProgressStories.size > 0) {
                const lastInProgress = Array.from(inProgressStories.entries())[0];
                const story = allStories.find(s => s.story_id === lastInProgress[0]);
                if (story) {
                    document.getElementById('continueTitle').textContent = story.title;
                    document.getElementById('continueProgress').textContent = lastInProgress[1];
                    continueReading.classList.remove('hidden');
                }
            }
            
            if (unreadStories.length === 0) {
                storiesGrid.style.display = 'none';
                noStoriesMessage.classList.remove('hidden');
                return;
            }
            
            storiesGrid.style.display = 'grid';
            noStoriesMessage.classList.add('hidden');
            
            // Show random selection of unread stories (max 5)
            const randomStories = shuffleArray(unreadStories).slice(0, 5);
            
            randomStories.forEach(story => {
                const storyCard = document.createElement('div');
                storyCard.className = 'story-card';
                storyCard.onclick = () => readStory(story);
                
                // Calculate reading time (assuming 150 words per minute for grade level)
                const wordCount = story.text.split(/\s+/).length;
                const readingTime = Math.ceil(wordCount / 150);
                
                storyCard.innerHTML = `
                    <div class="story-nation">${story.nation}</div>
                    <div class="story-title">${story.title}</div>
                    <div class="story-preview">${story.text.substring(0, 100)}...</div>
                    <div class="story-meta">
                        <span class="reading-time">⏱️ ${readingTime} min</span>
                        <span>+10 points</span>
                    </div>
                `;
                
                storiesGrid.appendChild(storyCard);
            });
            
            updateProgress();
        }

        function filterStories() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const storyCards = document.querySelectorAll('#storiesGrid .story-card');
            
            storyCards.forEach(card => {
                const title = card.querySelector('.story-title').textContent.toLowerCase();
                const nation = card.querySelector('.story-nation').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || nation.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterCompletedStories() {
            const searchTerm = document.getElementById('searchCompletedInput').value.toLowerCase();
            const storyCards = document.querySelectorAll('#completedStoriesGrid .story-card');
            
            storyCards.forEach(card => {
                const title = card.querySelector('.story-title').textContent.toLowerCase();
                const nation = card.querySelector('.story-nation').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || nation.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function loadUserProgress() {
            try {
                console.log('Loading user progress for:', currentUser.id);
                
                const { data, error } = await supabase
                    .from('user_progress')
                    .
                