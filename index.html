<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Little Lores - Learn to Read</title>
    <style>
        /* ============================================================
           LITTLE LORES APP STYLES - v2.8
           Reading comprehension app for kids with global stories
           ============================================================ */

        /* Base Reset & Layout */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Marker Felt', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            color: #333; 
        }
        
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
        }

        /* ============================================================
           HEADER & NAVIGATION
           ============================================================ */

        .app-header { 
            text-align: center; 
            margin-bottom: 30px; 
            position: relative; 
        }
        
        .app-title { 
            font-size: 2.5rem; 
            color: white; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
            margin-bottom: 10px; 
        }
        
        .app-subtitle { 
            font-size: 1.2rem; 
            color: rgba(255,255,255,0.9); 
            margin-bottom: 20px; 
        }
        
        /* User Header (Top Right) */
        .user-header { 
            position: absolute; 
            top: 0; 
            right: 0; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: white; 
            font-size: 0.9rem; 
        }
        
        .user-avatar { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            border: 2px solid white; 
        }
        
        .logout-btn { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 15px; 
            padding: 5px 12px; 
            cursor: pointer; 
            font-size: 0.8rem; 
            transition: all 0.3s ease; 
        }
        
        .logout-btn:hover { 
            background: rgba(255,255,255,0.3); 
        }
        
        /* Navigation Menu */
        .nav-menu { 
            display: flex; 
            gap: 8px; 
            justify-content: center; 
            flex-wrap: wrap; 
            margin-top: 15px; 
        }
        
        .nav-btn { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 2px solid rgba(255,255,255,0.3); 
            border-radius: 20px; 
            padding: 6px 12px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 0.8rem; 
        }
        
        .nav-btn:hover { 
            background: rgba(255,255,255,0.3); 
            transform: translateY(-2px); 
        }

        /* ============================================================
           CARD SYSTEM & ANIMATIONS
           ============================================================ */

        .card { 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            margin-bottom: 20px; 
            animation: fadeIn 0.6s ease-out; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* ============================================================
           HOME SCREEN COMPONENTS
           ============================================================ */

        .home-screen { 
            text-align: center; 
        }
        
        .welcome-section { 
            margin-bottom: 30px; 
        }
        
        .welcome-title { 
            font-size: 2rem; 
            color: #333; 
            margin-bottom: 10px; 
        }
        
        /* User Stats Card */
        .user-stats { 
            background: linear-gradient(135deg, #ffeaa7, #fab1a0); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 20px 0; 
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 15px; 
            margin-top: 15px; 
        }
        
        .stat-item { 
            text-align: center; 
        }
        
        .stat-number { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #2d3436; 
        }
        
        .stat-label { 
            font-size: 0.9rem; 
            color: #636e72; 
        }
        
        /* Home Action Buttons */
        .home-actions { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin: 30px 0; 
        }
        
        .home-action-btn { 
            border: none; 
            border-radius: 20px; 
            padding: 25px 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            color: white; 
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .home-action-btn:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }
        
        /* Action Button Color Variations */
        .home-action-btn.continue { background: linear-gradient(135deg, #00b894, #00a085); }
        .home-action-btn.surprise { background: linear-gradient(135deg, #fd79a8, #e84393); }
        .home-action-btn.settings { background: linear-gradient(135deg, #fdcb6e, #e17055); }
        .home-action-btn.completed { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        
        .action-icon { 
            font-size: 2rem; 
            margin-bottom: 10px; 
        }
        
        .action-title { 
            font-size: 1.2rem; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        
        .action-subtitle { 
            font-size: 0.9rem; 
            opacity: 0.9; 
        }

        /* ============================================================
           SELECTION SCREENS (Grade/Region)
           ============================================================ */

        .grade-selector, .region-selector { 
            text-align: center; 
        }
        
        .options-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        
        .option-btn { 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); 
            border: none; 
            border-radius: 15px; 
            padding: 20px; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            color: #333; 
            font-weight: bold; 
        }
        
        .option-btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
        }
        
        .option-btn.selected { 
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
            border: 3px solid #4ecdc4; 
        }

        /* ============================================================
           STORY DISPLAY COMPONENTS
           ============================================================ */

        .stories-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        
        .story-card { 
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); 
            border-radius: 15px; 
            padding: 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border: 3px solid transparent; 
        }
        
        .story-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.2); 
            border-color: #ff6b6b; 
        }
        
        .story-card.completed { 
            background: linear-gradient(135deg, #c3f0ca 0%, #b8e6c1 100%); 
        }
        
        .story-title { 
            font-size: 1.3rem; 
            font-weight: bold; 
            margin-bottom: 10px; 
            color: #333; 
        }
        
        .story-nation { 
            background: rgba(255,255,255,0.7); 
            padding: 5px 12px; 
            border-radius: 20px; 
            display: inline-block; 
            font-size: 0.9rem; 
            margin-bottom: 10px; 
        }
        
        .story-preview { 
            font-size: 0.9rem; 
            color: #666; 
            line-height: 1.4; 
        }

        /* ============================================================
           READING INTERFACE
           ============================================================ */

        .reading-view { 
            max-height: 600px; 
            overflow-y: auto; 
        }
        
        /* Story Text with Border */
        .story-text { 
            font-size: 1.2rem; 
            line-height: 1.8; 
            margin: 20px 0; 
            padding: 15px;
            text-align: justify; 
            white-space: pre-line;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.95);
        }
        
        /* Reading Controls */
        .reading-controls { 
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap; 
            justify-content: center; 
            margin: 20px 0; 
            align-items: center; 
        }
        
        .control-btn { 
            background: #4ecdc4; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            padding: 10px 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 0.9rem; 
        }
        
        .control-btn:hover { 
            background: #45b7aa; 
            transform: translateY(-2px); 
        }

        /* ============================================================
           VOICE & SLIDER CONTROLS
           ============================================================ */

        .slider-control { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px; 
            background: rgba(255,255,255,0.95); 
            padding: 15px; 
            border-radius: 15px; 
            min-width: 140px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        
        .slider-label { 
            font-size: 0.85rem; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 2px; 
        }
        
        .slider-value { 
            font-size: 0.75rem; 
            color: #666; 
            margin-top: 3px; 
            min-height: 1rem; 
        }
        
        /* Voice Dropdown */
        .voice-dropdown {
            width: 120px;
            padding: 6px 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 0.8rem;
            color: #333;
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .voice-dropdown:hover, 
        .voice-dropdown:focus {
            border-color: #4ecdc4;
        }
        
        /* Voice Preview Button */
        .voice-preview-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-top: 2px;
        }
        
        .voice-preview-btn:hover {
            background: #45b7aa;
            transform: scale(1.1);
        }
        
        /* Slider Styling */
        .slider { 
            -webkit-appearance: none;
            appearance: none;
            width: 120px; 
            height: 8px; 
            border-radius: 4px; 
            background: #ddd; 
            outline: none; 
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .slider:hover {
            background: #ccc;
        }
        
        /* WebKit Slider Thumb */
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #45b7aa;
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }
        
        /* Firefox Slider Thumb */
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ============================================================
           PROGRESS & UI ELEMENTS
           ============================================================ */

        .progress-bar { 
            background: #e0e0e0; 
            height: 8px; 
            border-radius: 4px; 
            margin: 20px 0; 
            overflow: hidden; 
        }
        
        .progress-fill { 
            background: linear-gradient(90deg, #4ecdc4, #44a08d); 
            height: 100%; 
            transition: width 0.3s ease; 
        }
        
        .back-btn { 
            background: #95a5a6; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            padding: 10px 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            margin-bottom: 20px; 
        }
        
        .back-btn:hover { 
            background: #7f8c8d; 
        }
        
        .user-info { 
            text-align: center; 
            margin-bottom: 20px; 
            color: white; 
        }

        /* ============================================================
           UTILITY CLASSES
           ============================================================ */

        .hidden { 
            display: none; 
        }
        
        .loading { 
            text-align: center; 
            padding: 20px; 
            color: #666; 
        }
        
        .error { 
            background: #ffe6e6; 
            border: 2px solid #ff6b6b; 
            border-radius: 10px; 
            padding: 15px; 
            margin: 10px 0; 
            color: #d63031; 
        }
        
        .reading-assistance { 
            background: #fff3cd; 
            border: 2px solid #ffeaa7; 
            border-radius: 10px; 
            padding: 15px; 
            margin: 10px 0; 
            font-size: 0.9rem; 
        }
        
        .word-help { 
            background: #e3f2fd; 
            padding: 3px 8px; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        
        .word-help:hover { 
            background: #bbdefb; 
        }
        
        /* Login Screen */
        .login-screen { 
            text-align: center; 
        }
        
        .google-login-btn { 
            background: #4285f4; 
            color: white; 
            border: none; 
            border-radius: 50px; 
            padding: 15px 30px; 
            font-size: 1.1rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .google-login-btn:hover { 
            background: #3367d6; 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }

        /* ============================================================
           MOBILE RESPONSIVE DESIGN
           ============================================================ */

        @media (max-width: 600px) {
            .app-title { font-size: 2rem; }
            .container { padding: 10px; }
            .card { padding: 20px; }
            .options-grid, .home-actions { grid-template-columns: 1fr; }
            .nav-btn { font-size: 0.7rem; padding: 5px 10px; }
            .user-header { position: static; justify-content: center; margin-bottom: 15px; }
            .home-action-btn { min-height: 100px; padding: 20px 15px; }
            .action-icon { font-size: 1.5rem; }
            .action-title { font-size: 1rem; }
            
            /* Mobile Reading Controls */
            .reading-controls { 
                gap: 12px;
                padding: 15px 10px;
                margin: 15px -10px;
                scroll-padding: 10px;
            }
            
            .control-btn {
                padding: 12px 18px;
                font-size: 0.85rem;
                min-width: 120px;
            }
            
            .slider-control { 
                min-width: 160px;
                max-width: 160px;
                padding: 18px;
            }
            
            .slider, .voice-dropdown { 
                width: 130px; 
            }
            
            .voice-preview-btn {
                margin-top: 5px;
                width: 30px;
                height: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ============================================================
             APP HEADER - Title, User Info, Navigation
             ============================================================ -->
        <div class="app-header">
            <h1 class="app-title">üìö Little Lores</h1>
            <p class="app-subtitle">Discover the world through reading!</p>
            
            <!-- User Info (Top Right) -->
            <div id="userHeader" class="user-header hidden">
                <img id="userAvatar" class="user-avatar" src="" alt="User">
                <span id="userNameHeader"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            
            <!-- Navigation Menu -->
            <div id="navMenu" class="nav-menu hidden">
                <button class="nav-btn" onclick="showHome()">üè† Home</button>
                <button class="nav-btn" onclick="showGradeSelect()">üìö Grade</button>
                <button class="nav-btn" onclick="showRegionSelect()">üó∫Ô∏è Region</button>
                <button class="nav-btn" onclick="showStoriesRead()">‚úÖ Read</button>
            </div>
        </div>

        <!-- ============================================================
             LOGIN SCREEN
             ============================================================ -->
        <div id="loginScreen" class="card login-screen">
            <h2>Welcome, Young Explorer! üìö</h2>
            <p style="margin: 20px 0;">Let's start your reading adventure around the world!</p>
            <button class="google-login-btn" onclick="handleLogin()">
                <span>üîê</span> Login with Google
            </button>
            <div id="loginError" class="error hidden"></div>
        </div>

        <!-- ============================================================
             LOADING SCREEN
             ============================================================ -->
        <div id="loadingScreen" class="card loading hidden">
            <h2>Loading your stories... üìñ</h2>
            <p>Please wait while we prepare your reading adventure!</p>
        </div>

        <!-- ============================================================
             HOME SCREEN - Main Dashboard
             ============================================================ -->
        <div id="homeScreen" class="card home-screen hidden">
            <div class="welcome-section">
                <h2 class="welcome-title">Welcome back, <span id="userNameHome">Reader</span>! üåü</h2>
                <p style="color: #636e72; margin-bottom: 20px;">What would you like to do today?</p>
            </div>

            <!-- User Reading Stats -->
            <div class="user-stats">
                <h3 style="margin-bottom: 15px; color: #2d3436;">üìä Your Reading Journey</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="statsCompleted">0</div>
                        <div class="stat-label">Stories Read</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statsGrade">-</div>
                        <div class="stat-label">Grade Level</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statsRegion">-</div>
                        <div class="stat-label">Favorite Region</div>
                    </div>
                </div>
            </div>

            <!-- Main Action Buttons -->
            <div class="home-actions">
                <button class="home-action-btn continue" onclick="continueReading()">
                    <div class="action-icon">üìñ</div>
                    <div class="action-title">Read</div>
                    <div class="action-subtitle">Explore new stories</div>
                </button>

                <button class="home-action-btn surprise" onclick="surpriseStory()">
                    <div class="action-icon">üé≤</div>
                    <div class="action-title">Surprise Story</div>
                    <div class="action-subtitle">Random story just for you</div>
                </button>

                <button class="home-action-btn settings" onclick="showSettings()">
                    <div class="action-icon">‚öôÔ∏è</div>
                    <div class="action-title">Settings</div>
                    <div class="action-subtitle">Change grade or region</div>
                </button>

                <button class="home-action-btn completed" onclick="showStoriesRead()">
                    <div class="action-icon">üèÜ</div>
                    <div class="action-title">Stories Read</div>
                    <div class="action-subtitle">Review your achievements</div>
                </button>
            </div>
        </div>

        <!-- ============================================================
             SETTINGS SCREEN
             ============================================================ -->
        <div id="settingsScreen" class="card hidden">
            <button class="back-btn" onclick="showHome()">‚Üê Back to Home</button>
            <h2 style="text-align: center; margin-bottom: 30px;">‚öôÔ∏è Settings</h2>
            
            <div class="options-grid">
                <button class="option-btn" onclick="showGradeSelect()">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">üìö</div>
                    <div>Change Grade</div>
                    <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">Current: <span id="currentGradeDisplay">-</span></div>
                </button>
                
                <button class="option-btn" onclick="showRegionSelect()">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">üó∫Ô∏è</div>
                    <div>Change Region</div>
                    <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">Current: <span id="currentRegionDisplay">-</span></div>
                </button>
            </div>
        </div>

        <!-- ============================================================
             GRADE SELECTION SCREEN
             ============================================================ -->
        <div id="gradeScreen" class="card grade-selector hidden">
            <button class="back-btn" onclick="goBackOrHome()">‚Üê Back</button>
            <h2>What grade are you in? üéì</h2>
            <div class="options-grid">
                <button class="option-btn" onclick="selectGrade('K-1')">Kindergarten - 1st Grade</button>
                <button class="option-btn" onclick="selectGrade('2-3')">2nd - 3rd Grade</button>
                <button class="option-btn" onclick="selectGrade('4-5')">4th - 5th Grade</button>
                <button class="option-btn" onclick="selectGrade('6-8')">6th - 8th Grade</button>
            </div>
        </div>

        <!-- ============================================================
             REGION SELECTION SCREEN
             ============================================================ -->
        <div id="regionScreen" class="card region-selector hidden">
            <button class="back-btn" onclick="goBackOrHome()">‚Üê Back</button>
            <div class="user-info">
                <p>Hello, <span id="userName">Student</span>! Grade: <span id="userGrade"></span></p>
            </div>
            <h2>Which part of the world would you like to explore? üó∫Ô∏è</h2>
            <div class="options-grid">
                <button class="option-btn" onclick="selectRegion('Africa')">üåç Africa</button>
                <button class="option-btn" onclick="selectRegion('Asia')">üèØ Asia</button>
                <button class="option-btn" onclick="selectRegion('Europe')">üè∞ Europe</button>
                <button class="option-btn" onclick="selectRegion('Americas')">üóΩ Americas</button>
                <button class="option-btn" onclick="selectRegion('Oceania')">üèùÔ∏è Oceania</button>
                <button class="option-btn" onclick="selectRegion('Mixed')">üåà Surprise Me!</button>
            </div>
        </div>

        <!-- ============================================================
             STORIES SELECTION SCREEN
             ============================================================ -->
        <div id="storiesScreen" class="card hidden">
            <button class="back-btn" onclick="showHome()">‚Üê Back to Home</button>
            <div class="user-info">
                <p><span id="userNameStories"></span> | Grade: <span id="userGradeStories"></span> | Region: <span id="userRegionStories"></span></p>
            </div>
            <h2>Choose your next adventure! üìñ</h2>
            
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p style="text-align: center; margin: 10px 0;">Stories completed: <span id="completedCount">0</span></p>
            
            <!-- Stories Grid -->
            <div class="stories-grid" id="storiesGrid">
                <!-- Stories dynamically loaded from Supabase -->
            </div>
            
            <!-- No Stories Available Message -->
            <div id="noStoriesMessage" class="hidden" style="text-align: center; padding: 40px;">
                <h3>üìö No new stories available!</h3>
                <p>You've read all the stories in this region. Try exploring a different region!</p>
                <button class="control-btn" onclick="showSettings()" style="margin-top: 15px;">Change Settings</button>
            </div>
        </div>

        <!-- ============================================================
             STORIES READ SCREEN - Completed Stories
             ============================================================ -->
        <div id="storiesReadScreen" class="card hidden">
            <button class="back-btn" onclick="showHome()">‚Üê Back to Home</button>
            <h2>Stories You've Read! üéâ</h2>
            <div class="user-info" style="color: #333;">
                <p><span id="userNameRead"></span> | Grade: <span id="userGradeRead"></span></p>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFillRead" style="width: 0%"></div>
            </div>
            <p style="text-align: center; margin: 10px 0;">Stories completed: <span id="completedCountRead">0</span></p>
            
            <!-- Completed Stories Grid -->
            <div id="completedStoriesGrid" class="stories-grid">
                <!-- Completed stories dynamically loaded -->
            </div>
            
            <!-- No Completed Stories Message -->
            <div id="noCompletedStories" class="hidden" style="text-align: center; padding: 40px;">
                <h3>üìñ No stories completed yet!</h3>
                <p>Start reading some amazing stories from around the world!</p>
                <button class="control-btn" onclick="continueReading()" style="margin-top: 15px;">Find Stories to Read</button>
            </div>
        </div>

        <!-- ============================================================
             READING SCREEN - Main Reading Interface
             ============================================================ -->
        <div id="readingScreen" class="card hidden">
            <button class="back-btn" onclick="backFromReading()">‚Üê Back</button>
            <div class="reading-view">
                <!-- Story Header -->
                <div class="story-nation" id="currentStoryNation"></div>
                <h2 class="story-title" id="currentStoryTitle"></h2>
                
                <!-- Reading Controls - Voice, Speed, Text Size -->
                <div class="reading-controls">
                    <!-- Basic Controls -->
                    <button class="control-btn" onclick="toggleReadingAssist()">üí° Reading Help</button>
                    <button class="control-btn" id="audioBtn" onclick="toggleAudio()">üîä Read Aloud</button>
                    <button class="control-btn" id="stopBtn" onclick="stopAudio()" style="display: none;">‚èπÔ∏è Stop</button>
                    
                    <!-- Speed Control -->
                    <div class="slider-control">
                        <div class="slider-label">üéµ Speed</div>
                        <input type="range" id="speedSlider" class="slider" min="0.5" max="2.0" step="0.1" value="0.75" oninput="adjustSpeedSlider(this.value)">
                        <div class="slider-value" id="speedValue">Gentle</div>
                    </div>
                    
                    <!-- Voice Selection -->
                    <div class="slider-control">
                        <div class="slider-label">üé≠ Voice</div>
                        <select id="voiceSelector" class="voice-dropdown" onchange="changeVoice(this.value)">
                            <option value="">Loading voices...</option>
                        </select>
                        <button class="voice-preview-btn" onclick="previewVoice()" title="Test this voice">‚ñ∂Ô∏è</button>
                    </div>
                    
                    <!-- Pitch/Tone Control -->
                    <div class="slider-control">
                        <div class="slider-label">üé∂ Tone</div>
                        <input type="range" id="pitchSlider" class="slider" min="0.7" max="1.5" step="0.1" value="1.1" oninput="adjustPitchSlider(this.value)">
                        <div class="slider-value" id="pitchValue">Warm</div>
                    </div>
                    
                    <!-- Font Size Control -->
                    <div class="slider-control">
                        <div class="slider-label">üîç Text Size</div>
                        <input type="range" id="fontSlider" class="slider" min="1" max="4" step="1" value="2" oninput="adjustFontSlider(this.value)">
                        <div class="slider-value" id="fontValue">Medium</div>
                    </div>
                </div>

                <!-- Reading Assistance Tips -->
                <div class="reading-assistance hidden" id="readingAssist">
                    <strong>Reading Tip:</strong> Click on highlighted words for help! Take your time and don't worry about reading perfectly.
                </div>

                <!-- Story Text Content -->
                <div class="story-text" id="currentStoryText"></div>
                
                <!-- Story Completion Button -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="control-btn" onclick="completeStory()" style="background: #27ae60; font-size: 1.1rem; padding: 15px 30px;">
                        ‚úÖ I finished reading!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================
         SUPABASE & JAVASCRIPT APPLICATION LOGIC
         ============================================================ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        /* ============================================================
           LITTLE LORES APP - JAVASCRIPT v3.0 - ENHANCED VOICE EDITION
           Main application logic with natural storytelling voice
           ============================================================ */

        // ============================================================
        // CONFIGURATION & INITIALIZATION
        // ============================================================

        // Supabase Database Configuration
        const SUPABASE_URL = 'https://mxjhvjwjgqmavmasfypa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14amh2andqZ3FtYXZtYXNmeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3Njk5NjEsImV4cCI6MjA2MDM0NTk2MX0.LLk01H7ueKFPMFpZfNOv3zx8VsICu6Gh6msuSjBW2x0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================================
        // GLOBAL STATE VARIABLES
        // ============================================================

        // User & Profile State
        let currentUser = null;
        let userProfile = null;
        let userGrade = null;
        let userRegion = null;

        // Story & Progress State
        let currentStory = null;
        let allStories = [];
        let completedStories = new Set();

        // UI State
        let currentScreen = 'loginScreen';
        let previousScreen = null;
        let textSizeLevel = 2;

        // Audio & Voice State - OPTIMIZED FOR STORYTELLING
        let currentUtterance = null;
        let isReading = false;
        let isPaused = false;
        let speechRate = 0.75;        // Default: Gentle pace for kids
        let speechPitch = 1.1;        // Default: Warm, friendly tone
        let selectedVoice = null;
        let availableVoices = [];
        let preferredVoiceCategory = 'Narrator (Female)';

        // Voice Categories for Organization
        let voiceCategories = {
            'Narrator (Female)': [],
            'Narrator (Male)': [],
            'Teacher (Female)': [],
            'Teacher (Male)': [],
            'Storyteller (Female)': [],
            'Storyteller (Male)': []
        };

        // ============================================================
        // SCREEN NAVIGATION FUNCTIONS
        // ============================================================

        /**
         * Navigate between different app screens
         * @param {string} screenId - The ID of the screen to show
         */
        function showScreen(screenId) {
            // Stop audio if leaving reading screen
            if (currentScreen === 'readingScreen' && isReading) {
                stopAudio();
            }
            
            // Hide all screens and show selected one
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            
            // Update screen tracking
            previousScreen = currentScreen;
            currentScreen = screenId;
        }

        function showLoading() {
            showScreen('loadingScreen');
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // ============================================================
        // HOME SCREEN FUNCTIONS
        // ============================================================

        function showHome() {
            updateHomeScreen();
            showScreen('homeScreen');
        }

        /**
         * Update home screen with current user stats
         */
        function updateHomeScreen() {
            if (currentUser) {
                document.getElementById('userNameHome').textContent = 
                    currentUser.user_metadata.full_name || 'Reader';
            }
            
            // Update reading statistics
            document.getElementById('statsCompleted').textContent = completedStories.size;
            document.getElementById('statsGrade').textContent = userGrade || '-';
            document.getElementById('statsRegion').textContent = userRegion || '-';
        }

        /**
         * Handle continue reading action - navigate to appropriate screen
         */
        function continueReading() {
            if (!userGrade) {
                showGradeSelect();
            } else if (!userRegion) {
                showRegionSelect();
            } else {
                loadStoriesAndShow();
            }
        }

        /**
         * Show a random surprise story for the user
         */
        async function surpriseStory() {
            if (!userGrade || !userRegion) {
                continueReading();
                return;
            }
            
            showLoading();
            await loadStories();
            
            const unreadStories = allStories.filter(story => !completedStories.has(story.story_id));
            
            if (unreadStories.length === 0) {
                showError('No new stories available! Try changing your region in settings.');
                showHome();
                return;
            }
            
            // Select random unread story
            const randomStory = unreadStories[Math.floor(Math.random() * unreadStories.length)];
            readStory(randomStory);
        }

        function showSettings() {
            document.getElementById('currentGradeDisplay').textContent = userGrade || '-';
            document.getElementById('currentRegionDisplay').textContent = userRegion || '-';
            showScreen('settingsScreen');
        }

        function goBackOrHome() {
            if (currentUser && userProfile && userProfile.grade) {
                showHome();
            } else if (previousScreen && previousScreen !== currentScreen) {
                showScreen(previousScreen);
            } else {
                showHome();
            }
        }

        function backFromReading() {
            if (previousScreen === 'storiesScreen') {
                showScreen('storiesScreen');
            } else {
                showHome();
            }
        }

        // ============================================================
        // AUTHENTICATION FUNCTIONS
        // ============================================================

        /**
         * Handle Google OAuth login
         */
        async function handleLogin() {
            try {
                showLoading();
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://ccalde29.github.io/LittleLoreApp/'
                    }
                });
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please try again.');
                showScreen('loginScreen');
            }
        }

        /**
         * Handle user logout - clear all data and return to login
         */
        async function logout() {
            try {
                console.log('Logging out user...');
                
                if (isReading) stopAudio();
                
                const { error } = await supabase.auth.signOut();
                if (error) console.error('Supabase logout error:', error);
                
                // Clear all stored data
                localStorage.clear();
                sessionStorage.clear();
                
                // Reset application state
                currentUser = null;
                userGrade = null;
                userRegion = null;
                currentStory = null;
                completedStories.clear();
                textSizeLevel = 2;
                allStories = [];
                userProfile = null;
                
                // Hide user interface elements
                document.getElementById('navMenu').classList.add('hidden');
                document.getElementById('userHeader').classList.add('hidden');
                
                showScreen('loginScreen');
                
                // Force page reload as backup
                setTimeout(() => window.location.reload(), 100);
                
            } catch (error) {
                console.error('Logout error:', error);
                // Fallback logout procedure
                document.getElementById('navMenu').classList.add('hidden');
                document.getElementById('userHeader').classList.add('hidden');
                showScreen('loginScreen');
                setTimeout(() => window.location.reload(), 1000);
            }
        }

        // ============================================================
        // AUTHENTICATION STATE HANDLER
        // ============================================================

        /**
         * Handle authentication state changes from Supabase
         */
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state change:', event, session?.user?.email);
            
            if (event === 'SIGNED_IN' && session) {
                console.log('User signed in');
                currentUser = session.user;
                
                // Show user interface
                document.getElementById('navMenu').classList.remove('hidden');
                document.getElementById('userHeader').classList.remove('hidden');
                document.getElementById('userNameHeader').textContent = 
                    currentUser.user_metadata.full_name || currentUser.email;
                document.getElementById('userAvatar').src = 
                    currentUser.user_metadata.avatar_url || 
                    'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                
                // Load user profile and progress
                if (!userProfile) {
                    await loadUserProfile();
                    await loadUserProgress();
                    
                    if (userProfile && userProfile.grade) {
                        userGrade = userProfile.grade;
                        userRegion = userProfile.preferred_nation;
                        
                        // Update UI with user data
                        if (userGrade) {
                            document.getElementById('userName').textContent = 
                                currentUser.user_metadata.full_name || currentUser.email;
                            document.getElementById('userGrade').textContent = userGrade;
                            document.getElementById('userGradeStories').textContent = userGrade;
                            document.getElementById('userNameStories').textContent = 
                                currentUser.user_metadata.full_name || currentUser.email;
                        }
                        
                        if (userRegion) {
                            document.getElementById('userRegionStories').textContent = userRegion;
                        }
                    }
                }
                
                // Navigate to home screen
                if (currentScreen === 'loginScreen' || currentScreen === 'loadingScreen') {
                    showHome();
                }
                
            } else if (event === 'SIGNED_OUT') {
                console.log('User signed out');
                
                // Reset all state
                currentUser = null;
                userGrade = null;
                userRegion = null;
                userProfile = null;
                completedStories.clear();
                allStories = [];
                
                // Hide user interface
                document.getElementById('userHeader').classList.add('hidden');
                document.getElementById('navMenu').classList.add('hidden');
                showScreen('loginScreen');
            }
        });

        // ============================================================
        // USER PROFILE MANAGEMENT
        // ============================================================

        /**
         * Load user profile from Supabase database
         */
        async function loadUserProfile() {
            try {
                console.log('Loading profile for user:', currentUser.id);
                
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                
                userProfile = data;
                console.log('Loaded user profile:', userProfile);
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        /**
         * Save user profile to Supabase database
         */
        async function saveUserProfile() {
            try {
                console.log('Saving profile:', { userGrade, userRegion });
                
                const profileData = {
                    user_id: currentUser.id,
                    grade: userGrade,
                    preferred_nation: userRegion,
                    onboarding_complete: true,
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('user_profiles')
                    .upsert(profileData, { 
                        onConflict: 'user_id',
                        ignoreDuplicates: false 
                    });
                
                if (error) throw error;
                
                userProfile = { ...profileData };
                console.log('Profile saved successfully');
                
            } catch (error) {
                console.error('Error saving user profile:', error);
                alert('Failed to save profile. Please try again.');
            }
        }

        // ============================================================
        // NAVIGATION HELPER FUNCTIONS
        // ============================================================

        function showGradeSelect() {
            showScreen('gradeScreen');
        }

        function showRegionSelect() {
            showScreen('regionScreen');
        }

        async function showStoriesRead() {
            await loadCompletedStories();
            showScreen('storiesReadScreen');
        }

        async function loadStoriesAndShow() {
            showLoading();
            await loadStories();
            showScreen('storiesScreen');
        }

        // ============================================================
        // GRADE AND REGION SELECTION
        // ============================================================

        /**
         * Handle grade selection
         * @param {string} grade - Selected grade level
         */
        async function selectGrade(grade) {
            userGrade = grade;
            document.getElementById('userGrade').textContent = grade;
            document.getElementById('userGradeStories').textContent = grade;
            
            // Visual feedback
            document.querySelectorAll('#gradeScreen .option-btn').forEach(btn => 
                btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            await saveUserProfile();
            
            // Navigate to next step
            setTimeout(() => {
                if (userRegion) {
                    showHome();
                } else {
                    showScreen('regionScreen');
                }
            }, 500);
        }

        /**
         * Handle region selection
         * @param {string} region - Selected world region
         */
        async function selectRegion(region) {
            userRegion = region;
            document.getElementById('userRegionStories').textContent = region;
            document.getElementById('userNameStories').textContent = 
                currentUser.user_metadata.full_name || currentUser.email;
            
            // Visual feedback
            document.querySelectorAll('#regionScreen .option-btn').forEach(btn => 
                btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            await saveUserProfile();
            
            // Navigate to home
            setTimeout(() => showHome(), 500);
        }

        // ============================================================
        // STORY MANAGEMENT FUNCTIONS
        // ============================================================

        /**
         * Load stories from Supabase based on user grade and region
         */
        async function loadStories() {
            try {
                console.log('Loading stories for region:', userRegion, 'grade:', userGrade);
                
                // Determine allowed grade levels (current + next level)
                const gradeOrder = ['K-1', '2-3', '4-5', '6-8'];
                const userIndex = gradeOrder.indexOf(userGrade);
                let allowedGrades = [userGrade];
                
                if (userIndex >= 0 && userIndex < gradeOrder.length - 1) {
                    allowedGrades.push(gradeOrder[userIndex + 1]);
                }
                
                // Build database query
                let query = supabase
                    .from('stories_raw')
                    .select('*')
                    .in('grade_level', allowedGrades);
                
                if (userRegion && userRegion !== 'Mixed') {
                    query = query.eq('region', userRegion);
                }
                
                const { data, error } = await query;
                if (error) throw error;
                
                allStories = data || [];
                console.log('Loaded stories:', allStories.length, 'for grades:', allowedGrades);
                displayStories();
                
            } catch (error) {
                console.error('Error loading stories:', error);
                showError('Failed to load stories. Please check your database connection.');
            }
        }

        /**
         * Display stories in the stories grid
         */
        function displayStories() {
            const storiesGrid = document.getElementById('storiesGrid');
            const noStoriesMessage = document.getElementById('noStoriesMessage');
            storiesGrid.innerHTML = '';
            
            // Filter unread stories
            const unreadStories = allStories.filter(story => 
                !completedStories.has(story.story_id));
            
            if (unreadStories.length === 0) {
                storiesGrid.style.display = 'none';
                noStoriesMessage.classList.remove('hidden');
                return;
            }
            
            storiesGrid.style.display = 'grid';
            noStoriesMessage.classList.add('hidden');
            
            // Show 5 random stories
            const randomStories = shuffleArray(unreadStories).slice(0, 5);
            
            randomStories.forEach(story => {
                const storyCard = document.createElement('div');
                storyCard.className = 'story-card';
                storyCard.onclick = () => readStory(story);
                
                storyCard.innerHTML = `
                    <div class="story-nation">${story.nation}</div>
                    <div class="story-title">${story.title}</div>
                    <div class="story-preview">${story.text.substring(0, 100)}...</div>
                `;
                
                storiesGrid.appendChild(storyCard);
            });
            
            updateProgress();
        }

        /**
         * Load user's reading progress from database
         */
        async function loadUserProgress() {
            try {
                console.log('Loading user progress for:', currentUser.id);
                
                const { data, error } = await supabase
                    .from('user_progress')
                    .select('story_id')
                    .eq('user_id', currentUser.id)
                    .not('completed', 'is', null);
                
                if (error) throw error;
                
                completedStories.clear();
                if (data) {
                    data.forEach(progress => {
                        completedStories.add(progress.story_id);
                    });
                }
                
                console.log('Completed stories:', Array.from(completedStories));
                
            } catch (error) {
                console.error('Error loading user progress:', error);
                completedStories.clear();
            }
        }

        /**
         * Load and display completed stories
         */
        async function loadCompletedStories() {
            const completedGrid = document.getElementById('completedStoriesGrid');
            const noStoriesMsg = document.getElementById('noCompletedStories');
            
            // Update user info display
            if (currentUser && userGrade) {
                document.getElementById('userNameRead').textContent = 
                    currentUser.user_metadata.full_name || currentUser.email;
                document.getElementById('userGradeRead').textContent = userGrade;
            }
            
            if (completedStories.size === 0) {
                completedGrid.style.display = 'none';
                noStoriesMsg.classList.remove('hidden');
                return;
            }
            
            completedGrid.style.display = 'grid';
            noStoriesMsg.classList.add('hidden');
            completedGrid.innerHTML = '';
            
            try {
                // Fetch completed story details
                const completedIds = Array.from(completedStories);
                const { data, error } = await supabase
                    .from('stories_raw')
                    .select('*')
                    .in('story_id', completedIds);
                
                if (error) throw error;
                
                // Display completed stories
                data.forEach(story => {
                    const storyCard = document.createElement('div');
                    storyCard.className = 'story-card completed';
                    storyCard.onclick = () => readStory(story);
                    
                    storyCard.innerHTML = `
                        <div class="story-nation">${story.nation}</div>
                        <div class="story-title">${story.title}</div>
                        <div class="story-preview">${story.text.substring(0, 100)}...</div>
                        <div style="margin-top: 10px; color: #27ae60; font-weight: bold;">‚úÖ Completed</div>
                    `;
                    
                    completedGrid.appendChild(storyCard);
                });
                
            } catch (error) {
                console.error('Error loading completed stories:', error);
            }
            
            updateProgressOnReadScreen();
        }

        // ============================================================
        // READING FUNCTIONS WITH ENHANCED VOICE SYSTEM
        // ============================================================

        /**
         * Start reading a selected story
         * @param {Object} story - Story object from database
         */
        function readStory(story) {
			// Just fetch and play the pre-generated audio
			const audioPlayer = new Audio(story.audio_url);
			audioPlayer.play();
  
			// Optional: Keep speed control (HTML5 supports playbackRate)
			audioPlayer.playbackRate = userSpeedPreference; // 0.75x to 1.25x
}

        // ============================================================
        // ENHANCED VOICE SYSTEM FOR NATURAL STORYTELLING
        // ============================================================

        /**
         * Initialize the voice system for text-to-speech
         */
        async function initializeVoiceSystem() {
            console.log('Initializing enhanced voice system...');
            
            // Wait for voices to load
            if (speechSynthesis.getVoices().length === 0) {
                await new Promise(resolve => {
                    speechSynthesis.onvoiceschanged = resolve;
                    setTimeout(resolve, 1000); // Fallback timeout
                });
            }
            
            availableVoices = speechSynthesis.getVoices();
            console.log('Found voices:', availableVoices.length);
            
            if (availableVoices.length > 0) {
                categorizeVoices();
                populateVoiceSelector();
                selectBestStorytellingVoice(); // Enhanced selection
                loadVoicePreferences();
            } else {
                console.warn('No voices available');
                document.getElementById('voiceSelector').innerHTML = 
                    '<option value="">Default Voice</option>';
            }
        }
        
        /**
         * Select the best voice specifically for storytelling to children
         * Prioritizes warm, clear, natural-sounding voices
         */
        function selectBestStorytellingVoice() {
            console.log('Selecting best storytelling voice...');
            
            // Priority list: Best voices for reading to children
            const storytellingPriorities = [
                // macOS voices (excellent quality)
                v => v.name.includes('Samantha') && v.lang.includes('en'),
                v => v.name.includes('Karen') && v.lang.includes('en'),
                v => v.name.includes('Moira') && v.lang.includes('en'),
                v => v.name.includes('Tessa') && v.lang.includes('en'),
                
                // Google voices (very good quality)
                v => v.name.includes('Google UK English Female'),
                v => v.name.includes('Google US English Female'),
                v => v.name.includes('Google') && v.name.includes('Female') && v.lang.includes('en'),
                
                // Microsoft voices (good quality)
                v => v.name.includes('Microsoft Zira'),
                v => v.name.includes('Microsoft Jenny'),
                v => v.name.includes('Microsoft Aria'),
                
                // Natural/Neural voices (any platform)
                v => v.name.toLowerCase().includes('natural') && v.lang.includes('en'),
                v => v.name.toLowerCase().includes('neural') && v.lang.includes('en'),
                v => v.name.toLowerCase().includes('premium') && v.lang.includes('en'),
                
                // Fallback: any female English voice
                v => v.lang.includes('en-US') && isFemaleVoice(v.name.toLowerCase()),
                v => v.lang.includes('en-GB') && isFemaleVoice(v.name.toLowerCase()),
                v => v.lang.includes('en') && isFemaleVoice(v.name.toLowerCase()),
                
                // Last resort: any English voice
                v => v.lang.includes('en')
            ];
            
            // Try each priority until we find a match
            for (const priority of storytellingPriorities) {
                const match = availableVoices.find(priority);
                if (match) {
                    selectedVoice = match;
                    console.log('Selected storytelling voice:', match.name);
                    
                    // Update UI
                    const category = Object.keys(voiceCategories).find(cat => 
                        voiceCategories[cat].includes(match)
                    );
                    if (category) {
                        preferredVoiceCategory = category;
                        document.getElementById('voiceSelector').value = category;
                    }
                    return;
                }
            }
            
            // Absolute fallback
            if (availableVoices.length > 0) {
                selectedVoice = availableVoices[0];
                console.log('Using fallback voice:', selectedVoice.name);
            }
        }

        /**
         * Categorize available voices by type and gender
         */
        function categorizeVoices() {
            // Reset categories
            Object.keys(voiceCategories).forEach(key => {
                voiceCategories[key] = [];
            });
            
            availableVoices.forEach(voice => {
                const name = voice.name.toLowerCase();
                const lang = voice.lang.toLowerCase();
                
                // Skip non-English voices
                if (!lang.includes('en')) return;
                
                // Determine voice characteristics
                const isFemale = isFemaleVoice(name);
                const isMale = !isFemale;
                const isHighQuality = isHighQualityVoice(name);
                const isNatural = isNaturalVoice(name);
                
                // Categorize voices based on quality and gender
                if (isHighQuality && isFemale) {
                    voiceCategories['Narrator (Female)'].push(voice);
                    if (isNatural) voiceCategories['Storyteller (Female)'].push(voice);
                } else if (isHighQuality && isMale) {
                    voiceCategories['Narrator (Male)'].push(voice);
                    if (isNatural) voiceCategories['Storyteller (Male)'].push(voice);
                } else if (isFemale) {
                    voiceCategories['Teacher (Female)'].push(voice);
                } else if (isMale) {
                    voiceCategories['Teacher (Male)'].push(voice);
                }
            });
            
            console.log('Voice categories:', voiceCategories);
        }

        /**
         * Determine if voice is female based on name patterns
         * @param {string} name - Voice name to analyze
         * @returns {boolean} True if voice appears to be female
         */
        function isFemaleVoice(name) {
            const femaleKeywords = [
                'female', 'woman', 'samantha', 'alex', 'victoria', 'karen', 'moira',
                'tessa', 'veena', 'fiona', 'kate', 'susan', 'allison', 'ava',
                'serena', 'sara', 'anna', 'emma', 'joanna', 'kendra', 'kimberly',
                'salli', 'raveena', 'aditi', 'priya', 'lekha', 'zira', 'hazel', 'nora',
                'jenny', 'aria'
            ];
            
            return femaleKeywords.some(keyword => name.includes(keyword));
        }

        /**
         * Determine if voice is high quality based on name patterns
         * @param {string} name - Voice name to analyze
         * @returns {boolean} True if voice appears to be high quality
         */
        function isHighQualityVoice(name) {
            const qualityKeywords = [
                'neural', 'premium', 'enhanced', 'natural', 'wavenet', 'google',
                'siri', 'samantha', 'alex', 'compact', 'quality', 'premium',
                'microsoft zira', 'microsoft jenny', 'microsoft aria', 'karen', 'moira'
            ];
            
            return qualityKeywords.some(keyword => name.includes(keyword));
        }

        /**
         * Determine if voice sounds natural based on name patterns
         * @param {string} name - Voice name to analyze
         * @returns {boolean} True if voice appears natural/expressive
         */
        function isNaturalVoice(name) {
            const naturalKeywords = [
                'neural', 'natural', 'expressive', 'conversational', 'storyteller',
                'enhanced', 'premium', 'samantha', 'karen'
            ];
            
            return naturalKeywords.some(keyword => name.includes(keyword));
        }

        /**
         * Populate the voice selector dropdown with categorized voices
         */
        function populateVoiceSelector() {
            const selector = document.getElementById('voiceSelector');
            selector.innerHTML = '';
            
            // Add options for each category that has voices
            Object.entries(voiceCategories).forEach(([category, voices]) => {
                if (voices.length > 0) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    selector.appendChild(option);
                }
            });
            
            // Fallback: if no categorized voices, add all English voices
            if (selector.children.length === 0) {
                const englishVoices = availableVoices.filter(voice => 
                    voice.lang.toLowerCase().includes('en')
                );
                
                if (englishVoices.length > 0) {
                    englishVoices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.name;
                        option.textContent = voice.name.length > 20 ? 
                            voice.name.substring(0, 20) + '...' : voice.name;
                        selector.appendChild(option);
                    });
                } else {
                    selector.innerHTML = '<option value="">Default Voice</option>';
                }
            }
        }

        /**
         * Change the selected voice
         * @param {string} categoryOrName - Voice category or specific voice name
         */
        function changeVoice(categoryOrName) {
            console.log('Changing voice to:', categoryOrName);
            
            if (voiceCategories[categoryOrName] && voiceCategories[categoryOrName].length > 0) {
                // Category selection
                preferredVoiceCategory = categoryOrName;
                selectedVoice = voiceCategories[categoryOrName][0];
            } else {
                // Direct voice name selection (fallback)
                selectedVoice = availableVoices.find(voice => voice.name === categoryOrName);
            }
            
            // Save preference to localStorage
            if (selectedVoice) {
                localStorage.setItem('littleLoresVoiceCategory', preferredVoiceCategory);
                console.log('Voice changed to:', selectedVoice.name);
            }
        }

        /**
         * Preview the currently selected voice
         */
        function previewVoice() {
            if (!selectedVoice) return;
            
            // Stop current audio
            if (isReading) stopAudio();
            
            // Create preview utterance
            const previewText = "Hello! This is how I sound when reading your stories.";
            const utterance = new SpeechSynthesisUtterance(previewText);
            utterance.voice = selectedVoice;
            utterance.rate = speechRate;
            utterance.pitch = speechPitch;
            
            // Visual feedback
            const previewBtn = document.querySelector('.voice-preview-btn');
            previewBtn.textContent = 'üîä';
            
            utterance.onend = () => previewBtn.textContent = '‚ñ∂Ô∏è';
            utterance.onerror = () => {
                previewBtn.textContent = '‚ñ∂Ô∏è';
                console.error('Voice preview error');
            };
            
            speechSynthesis.speak(utterance);
        }

        /**
         * Load saved voice preferences from localStorage
         */
        function loadVoicePreferences() {
            const savedCategory = localStorage.getItem('littleLoresVoiceCategory');
            const savedPitch = localStorage.getItem('littleLoresVoicePitch');
            
            if (savedCategory && voiceCategories[savedCategory]?.length > 0) {
                preferredVoiceCategory = savedCategory;
                selectedVoice = voiceCategories[savedCategory][0];
                document.getElementById('voiceSelector').value = savedCategory;
            }
            
            if (savedPitch) {
                speechPitch = parseFloat(savedPitch);
                document.getElementById('pitchSlider').value = speechPitch;
                updatePitchDisplay(speechPitch);
            }
        }

        /**
         * Enhance text for more natural storytelling speech
         * Adds strategic pauses and adjusts for better flow
         * @param {string} text - Original story text
         * @returns {string} Enhanced text with natural pauses
         */
        function enhanceTextForStorytelling(text) {
            let enhanced = text;
            
            // Add breathing pauses at sentence endings (like a real reader)
            enhanced = enhanced.replace(/\.\s+/g, '. ... ');
            enhanced = enhanced.replace(/!\s+/g, '! ... ');
            enhanced = enhanced.replace(/\?\s+/g, '? ... ');
            
            // Add slight pauses at commas (natural breathing)
            enhanced = enhanced.replace(/,\s+/g, ', . ');
            
            // Add pauses at colons (building anticipation)
            enhanced = enhanced.replace(/:\s+/g, ': .. ');
            
            // Add pauses at semicolons
            enhanced = enhanced.replace(/;\s+/g, '; .. ');
            
            // Add pause before opening quotes (preparing for dialogue)
            enhanced = enhanced.replace(/\s+"/g, ' .. "');
            
            // Add pause after closing quotes (finishing dialogue)
            enhanced = enhanced.replace(/"\s+/g, '" .. ');
            
            // Add pauses at em-dashes (dramatic pause)
            enhanced = enhanced.replace(/--/g, ' ... ');
            enhanced = enhanced.replace(/‚Äî/g, ' ... ');
            
            // Add slight pause at paragraph breaks (if any)
            enhanced = enhanced.replace(/\n\n/g, '\n ... \n');
            
            // Add emphasis pauses before exclamations
            enhanced = enhanced.replace(/([A-Z][a-z]+)!/g, '$1 !');
            
            return enhanced;
        }
        
        /**
         * Detect story mood/emotion to adjust voice settings
         * @param {string} text - Story text to analyze
         * @returns {string} Mood type: calm, exciting, mysterious, sad, happy
         */
        function detectStoryMood(text) {
            const lowerText = text.toLowerCase();
            
            // Exciting/Action words
            const excitingWords = ['suddenly', 'amazing', 'wonderful', 'ran', 'jumped', 'hurried', 'quickly', 'adventure', 'discovered', 'exciting'];
            const excitingCount = excitingWords.filter(word => lowerText.includes(word)).length;
            
            // Calm/Peaceful words
            const calmWords = ['peaceful', 'quiet', 'gentle', 'slowly', 'softly', 'calm', 'rest', 'sleep', 'dream'];
            const calmCount = calmWords.filter(word => lowerText.includes(word)).length;
            
            // Mysterious words
            const mysteriousWords = ['mysterious', 'strange', 'curious', 'wondered', 'secret', 'hidden', 'whispered'];
            const mysteriousCount = mysteriousWords.filter(word => lowerText.includes(word)).length;
            
            // Sad words
            const sadWords = ['sad', 'cried', 'tears', 'lonely', 'missed', 'lost', 'goodbye'];
            const sadCount = sadWords.filter(word => lowerText.includes(word)).length;
            
            // Happy words
            const happyWords = ['happy', 'joy', 'smiled', 'laughed', 'celebration', 'wonderful', 'delighted', 'cheerful'];
            const happyCount = happyWords.filter(word => lowerText.includes(word)).length;
            
            // Determine dominant mood
            const moods = {
                exciting: excitingCount,
                calm: calmCount,
                mysterious: mysteriousCount,
                sad: sadCount,
                happy: happyCount
            };
            
            const dominantMood = Object.keys(moods).reduce((a, b) => 
                moods[a] > moods[b] ? a : b
            );
            
            // Return calm as default if no strong signals
            return moods[dominantMood] > 1 ? dominantMood : 'calm';
        }
        
        /**
         * Get voice settings optimized for story mood
         * @param {string} mood - Story mood type
         * @returns {Object} Voice settings {rate, pitch, volume}
         */
        function getStorytellingVoiceSettings(mood) {
            const settings = {
                calm: { 
                    rate: 0.75,   // Slow, soothing
                    pitch: 1.0,   // Natural pitch
                    volume: 0.85  // Softer
                },
                exciting: { 
                    rate: 0.88,   // A bit faster
                    pitch: 1.2,   // Higher pitch for energy
                    volume: 0.95  // Slightly louder
                },
                mysterious: { 
                    rate: 0.70,   // Very slow for suspense
                    pitch: 0.95,  // Slightly lower
                    volume: 0.80  // Quieter
                },
                sad: { 
                    rate: 0.68,   // Very slow
                    pitch: 0.90,  // Lower pitch
                    volume: 0.80  // Softer
                },
                happy: { 
                    rate: 0.85,   // Moderately fast
                    pitch: 1.15,  // Brighter
                    volume: 0.90  // Pleasant volume
                }
            };
            
            return settings[mood] || settings.calm;
        }

        // ============================================================
        // SLIDER CONTROL FUNCTIONS
        // ============================================================

        /**
         * Update all slider displays with current values
         */
        function updateSliderDisplays() {
            document.getElementById('speedSlider').value = speechRate;
            updateSpeedDisplay(speechRate);
            
            document.getElementById('fontSlider').value = textSizeLevel;
            updateFontDisplay(textSizeLevel);
            
            document.getElementById('pitchSlider').value = speechPitch;
            updatePitchDisplay(speechPitch);
        }

        /**
         * Update speed display text based on rate value
         * @param {number} rate - Speech rate value
         */
        function updateSpeedDisplay(rate) {
            const speedNames = {
                0.5: 'Very Slow', 0.6: 'Slow', 0.7: 'Gentle', 0.8: 'Calm', 0.9: 'Steady',
                1.0: 'Normal', 1.1: 'Brisk', 1.2: 'Quick', 1.3: 'Fast', 1.4: 'Fast',
                1.5: 'Faster', 1.6: 'Very Fast', 1.7: 'Very Fast', 1.8: 'Very Fast',
                1.9: 'Very Fast', 2.0: 'Very Fast'
            };
            
            const closestRate = Object.keys(speedNames).reduce((prev, curr) => 
                Math.abs(curr - rate) < Math.abs(prev - rate) ? curr : prev
            );
            
            document.getElementById('speedValue').textContent = speedNames[closestRate];
        }

        /**
         * Update font size display text
         * @param {number} level - Font size level (1-4)
         */
        function updateFontDisplay(level) {
            const fontNames = { 1: 'Small', 2: 'Medium', 3: 'Large', 4: 'Extra Large' };
            document.getElementById('fontValue').textContent = fontNames[level];
        }

        /**
         * Update pitch display text based on pitch value
         * @param {number} pitch - Speech pitch value
         */
        function updatePitchDisplay(pitch) {
            const pitchNames = {
                0.7: 'Deep', 0.8: 'Low', 0.9: 'Natural', 1.0: 'Clear', 1.1: 'Warm',
                1.2: 'Bright', 1.3: 'High', 1.4: 'Sweet', 1.5: 'Very High'
            };
            
            const closestPitch = Object.keys(pitchNames).reduce((prev, curr) => 
                Math.abs(curr - pitch) < Math.abs(prev - pitch) ? curr : prev
            );
            
            document.getElementById('pitchValue').textContent = pitchNames[closestPitch];
        }

        /**
         * Adjust speech speed from slider
         * @param {string} value - New speed value from slider
         */
        function adjustSpeedSlider(value) {
            speechRate = parseFloat(value);
            updateSpeedDisplay(speechRate);
            
            // Restart audio with new speed if currently reading
            if (isReading && !isPaused) {
                stopAudio();
                setTimeout(startAudio, 100);
            }
        }

        /**
         * Adjust font size from slider
         * @param {string} value - New font size level from slider
         */
        function adjustFontSlider(value) {
            textSizeLevel = parseInt(value);
            updateFontDisplay(textSizeLevel);
            applyCurrentFontSize();
        }

        /**
         * Adjust speech pitch from slider
         * @param {string} value - New pitch value from slider
         */
        function adjustPitchSlider(value) {
            speechPitch = parseFloat(value);
            updatePitchDisplay(speechPitch);
            
            // Save preference
            localStorage.setItem('littleLoresVoicePitch', speechPitch);
            
            // Restart audio with new pitch if currently reading
            if (isReading && !isPaused) {
                stopAudio();
                setTimeout(startAudio, 100);
            }
        }

        /**
         * Apply current font size to story text
         */
        function applyCurrentFontSize() {
            const sizes = { 1: '1.0rem', 2: '1.2rem', 3: '1.5rem', 4: '1.8rem' };
            document.getElementById('currentStoryText').style.fontSize = sizes[textSizeLevel];
        }

        // ============================================================
        // WORD HIGHLIGHTING & HELP SYSTEM
        // ============================================================

        /**
         * Add word helpers to text for difficult words
         * @param {string} text - Story text to process
         * @returns {string} HTML with word helpers added
         */
        function addWordHelpers(text) {
            if (!userGrade) return text;
            
            // Define word length thresholds by grade
            const lengthThresholds = { 'K-1': 5, '2-3': 7, '4-5': 8, '6-8': 10 };
            const threshold = lengthThresholds[userGrade] || 8;
            const words = text.split(/(\s+)/);
            
            // Process each word
            const processedWords = words.map(word => {
                const cleanWord = word.replace(/[^\w]/g, '');
                
                if (cleanWord.length > threshold && /^[a-zA-Z]+/.test(cleanWord)) {
                    return word.replace(/\b[a-zA-Z]+\b/, match => 
                        `<span class="word-help" onclick="showWordHelp('${match.toLowerCase()}')" title="Click for help">${match}</span>`
                    );
                }
                return word;
            });
            
            return processedWords.join('');
        }

        /**
         * Toggle reading assistance tips
         */
        function toggleReadingAssist() {
            document.getElementById('readingAssist').classList.toggle('hidden');
        }

        // ============================================================
        // AUDIO CONTROL FUNCTIONS
        // ============================================================

        /**
         * Toggle audio playback (play/pause)
         */
        function toggleAudio() {
            if (!('speechSynthesis' in window)) {
                alert('üîä Audio feature is not supported in your browser.');
                return;
            }

            if (isReading) {
                if (isPaused) {
                    speechSynthesis.resume();
                    isPaused = false;
                    document.getElementById('audioBtn').innerHTML = '‚è∏Ô∏è Pause';
                } else {
                    speechSynthesis.pause();
                    isPaused = true;
                    document.getElementById('audioBtn').innerHTML = '‚ñ∂Ô∏è Resume';
                }
            } else {
                startAudio();
            }
        }

        /**
         * Start audio playback of current story with enhanced natural voice
         */
        function startAudio() {
            const text = document.getElementById('currentStoryText').textContent;
            
            // Detect story mood and get optimal settings
            const storyMood = detectStoryMood(text);
            const voiceSettings = getStorytellingVoiceSettings(storyMood);
            
            console.log('Story mood detected:', storyMood, 'Settings:', voiceSettings);
            
            // Enhance text with natural pauses
            const enhancedText = enhanceTextForStorytelling(text);
            
            currentUtterance = new SpeechSynthesisUtterance(enhancedText);
            
            // Apply storytelling-optimized voice settings
            if (selectedVoice) currentUtterance.voice = selectedVoice;
            
            // Use mood-based settings, but allow user overrides
            currentUtterance.rate = speechRate || voiceSettings.rate;
            currentUtterance.pitch = speechPitch || voiceSettings.pitch;
            currentUtterance.volume = voiceSettings.volume;
            
            // Set up event handlers
            currentUtterance.onstart = () => {
                isReading = true;
                isPaused = false;
                document.getElementById('audioBtn').innerHTML = '‚è∏Ô∏è Pause';
                document.getElementById('stopBtn').style.display = 'inline-block';
            };
            
            currentUtterance.onend = resetAudioControls;
            currentUtterance.onerror = () => {
                resetAudioControls();
                alert('Error with text-to-speech. Please try again.');
            };
            
            speechSynthesis.speak(currentUtterance);
        }

        /**
         * Stop audio playback
         */
        function stopAudio() {
            speechSynthesis.cancel();
            resetAudioControls();
        }

        /**
         * Reset audio control buttons to default state
         */
        function resetAudioControls() {
            isReading = false;
            isPaused = false;
            currentUtterance = null;
            document.getElementById('audioBtn').innerHTML = 'üîä Read Aloud';
            document.getElementById('stopBtn').style.display = 'none';
        }

        /**
         * Show help popup for difficult words
         * @param {string} word - Word to show definition for
         */
        function showWordHelp(word) {
            // Basic word definitions for common difficult words
            const definitions = {
                'magnificent': 'very beautiful and impressive',
                'cunning': 'clever in a sneaky way',
                'wisdom': 'knowledge and good judgment',
                'famine': 'when there is not enough food',
                'beautiful': 'very pretty or lovely',
                'disappeared': 'went away and could not be seen',
                'wonderful': 'very good and amazing',
                'ancient': 'very old, from long ago',
                'mysterious': 'hard to understand or explain',
                'adventure': 'an exciting experience or journey',
                'enormous': 'very very big',
                'dangerous': 'something that can hurt you',
                'incredible': 'amazing and hard to believe',
                'important': 'very special and needed',
                'different': 'not the same as something else',
                'together': 'at the same time or place',
                'remember': 'to think about something from before',
                'everywhere': 'in all places',
                'something': 'a thing, but we don\'t know what',
                'because': 'the reason why something happens'
            };
            
            const definition = definitions[word.toLowerCase()];
            
            if (definition) {
                alert(`üí° "${word}" means: ${definition}`);
            } else {
                alert(`üí° "${word}" is a longer word that might be tricky. Sound it out slowly, or ask for help!`);
            }
        }

        // ============================================================
        // STORY COMPLETION FUNCTIONS
        // ============================================================

        /**
         * Mark current story as completed
         */
        async function completeStory() {
            if (!currentStory) return;
            
            try {
                console.log('Completing story:', currentStory.story_id);
                
                const progressData = {
                    user_id: currentUser.id,
                    story_id: currentStory.story_id,
                    completed: new Date().toISOString(),
                    completed_at: new Date().toISOString(),
                    last_read: new Date().toISOString()
                };
                
                // Try to insert new progress record
                const { data, error } = await supabase
                    .from('user_progress')
                    .insert(progressData);
                
                if (error) {
                    // If insert fails, try update
                    console.log('Insert failed, trying update...');
                    const { data: updateData, error: updateError } = await supabase
                        .from('user_progress')
                        .update({
                            completed: new Date().toISOString(),
                            completed_at: new Date().toISOString(),
                            last_read: new Date().toISOString()
                        })
                        .eq('user_id', currentUser.id)
                        .eq('story_id', currentStory.story_id);
                    
                    if (updateError) throw updateError;
                }
                
                // Add to local completed stories set
                completedStories.add(currentStory.story_id);
                
                alert(`üéâ Great job reading "${currentStory.title}"! You're becoming a wonderful reader!`);
                showHome();
                
            } catch (error) {
                console.error('Error completing story:', error);
                // Still mark as completed locally
                completedStories.add(currentStory.story_id);
                alert('‚úÖ Story completed! (Saving failed, but progress recorded locally)');
                showHome();
            }
        }

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================

        /**
         * Shuffle an array randomly
         * @param {Array} array - Array to shuffle
         * @returns {Array} Shuffled copy of array
         */
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        /**
         * Update progress bar on stories screen
         */
        function updateProgress() {
            const totalAvailable = allStories.length;
            const completed = completedStories.size;
            const percentage = totalAvailable > 0 ? (completed / totalAvailable) * 100 : 0;
            
            document.getElementById('progressFill').style.width = `${percentage}%`;
            document.getElementById('completedCount').textContent = completed;
        }

        /**
         * Update progress bar on stories read screen
         */
        function updateProgressOnReadScreen() {
            const totalAvailable = allStories.length;
            const completed = completedStories.size;
            const percentage = totalAvailable > 0 ? (completed / totalAvailable) * 100 : 0;
            
            document.getElementById('progressFillRead').style.width = `${percentage}%`;
            document.getElementById('completedCountRead').textContent = completed;
        }

        // ============================================================
        // APP INITIALIZATION
        // ============================================================

        /**
         * Initialize the application when DOM is ready
         */
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Little Lores app initializing with enhanced voice...');
            
            showLoading();
            
            try {
                // Check for existing authentication session
                const { data: { session }, error } = await supabase.auth.getSession();
                console.log('Initial session check:', session?.user?.email, error);
                
                if (error) {
                    console.error('Session error:', error);
                    showScreen('loginScreen');
                    return;
                }
                
                if (session) {
                    console.log('User is already logged in, setting up...');
                    currentUser = session.user;
                    
                    // Show user interface
                    document.getElementById('navMenu').classList.remove('hidden');
                    document.getElementById('userHeader').classList.remove('hidden');
                    document.getElementById('userNameHeader').textContent = 
                        currentUser.user_metadata.full_name || currentUser.email;
                    document.getElementById('userAvatar').src = 
                        currentUser.user_metadata.avatar_url || 
                        'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                    
                    // Load user data
                    await loadUserProfile();
                    await loadUserProgress();
                    
                    if (userProfile && userProfile.grade) {
                        userGrade = userProfile.grade;
                        userRegion = userProfile.preferred_nation;
                        
                        // Update UI elements with user data
                        if (userGrade) {
                            document.getElementById('userName').textContent = 
                                currentUser.user_metadata.full_name || currentUser.email;
                            document.getElementById('userGrade').textContent = userGrade;
                            document.getElementById('userGradeStories').textContent = userGrade;
                            document.getElementById('userNameStories').textContent = 
                                currentUser.user_metadata.full_name || currentUser.email;
                        }
                        
                        if (userRegion) {
                            document.getElementById('userRegionStories').textContent = userRegion;
                        }
                    }
                    
                    console.log('Navigating to home screen');
                    showHome();
                    
                } else {
                    console.log('No session found, showing login');
                    showScreen('loginScreen');
                }
                
            } catch (error) {
                console.error('Error during initialization:', error);
                showScreen('loginScreen');
            }
        });

        // Handle OAuth redirect parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('error')) {
            showError('Login failed: ' + urlParams.get('error_description'));
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
</body>
</html>