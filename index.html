<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Little Lores - Learn to Read</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Comic Sans MS', cursive, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; }
        .app-header { text-align: center; margin-bottom: 30px; position: relative; }
        .app-title { font-size: 2.5rem; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px; }
        .app-subtitle { font-size: 1.2rem; color: rgba(255,255,255,0.9); margin-bottom: 20px; }
        
        .user-header { position: absolute; top: 0; right: 0; display: flex; align-items: center; gap: 10px; color: white; font-size: 0.9rem; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 15px; padding: 5px 12px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        
        .nav-menu { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        .nav-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 20px; padding: 6px 12px; cursor: pointer; transition: all 0.3s ease; font-size: 0.8rem; }
        .nav-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .login-screen { text-align: center; }
        .google-login-btn { background: #4285f4; color: white; border: none; border-radius: 50px; padding: 15px 30px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 10px; }
        .google-login-btn:hover { background: #3367d6; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .grade-selector, .region-selector { text-align: center; }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .option-btn { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); border: none; border-radius: 15px; padding: 20px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; color: #333; font-weight: bold; }
        .option-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .option-btn.selected { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border: 3px solid #4ecdc4; }
        
        .stories-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .story-card { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.3s ease; border: 3px solid transparent; }
        .story-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); border-color: #ff6b6b; }
        .story-card.completed { background: linear-gradient(135deg, #c3f0ca 0%, #b8e6c1 100%); }
        .story-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .story-nation { background: rgba(255,255,255,0.7); padding: 5px 12px; border-radius: 20px; display: inline-block; font-size: 0.9rem; margin-bottom: 10px; }
        .story-preview { font-size: 0.9rem; color: #666; line-height: 1.4; }
        
        .reading-view { max-height: 600px; overflow-y: auto; }
        .story-text { font-size: 1.2rem; line-height: 1.8; margin: 20px 0; text-align: justify; }
        .reading-controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 20px 0; }
        .control-btn { background: #4ecdc4; color: white; border: none; border-radius: 25px; padding: 10px 20px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; }
        .control-btn:hover { background: #45b7aa; transform: translateY(-2px); }
        
        .progress-bar { background: #e0e0e0; height: 8px; border-radius: 4px; margin: 20px 0; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #4ecdc4, #44a08d); height: 100%; transition: width 0.3s ease; }
        
        .back-btn { background: #95a5a6; color: white; border: none; border-radius: 25px; padding: 10px 20px; cursor: pointer; transition: all 0.3s ease; margin-bottom: 20px; }
        .back-btn:hover { background: #7f8c8d; }
        
        .user-info { text-align: center; margin-bottom: 20px; color: white; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { background: #ffe6e6; border: 2px solid #ff6b6b; border-radius: 10px; padding: 15px; margin: 10px 0; color: #d63031; }
        .reading-assistance { background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 10px; padding: 15px; margin: 10px 0; font-size: 0.9rem; }
        .word-help { background: #e3f2fd; padding: 3px 8px; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        .word-help:hover { background: #bbdefb; }
        
        @media (max-width: 600px) {
            .app-title { font-size: 2rem; }
            .container { padding: 10px; }
            .card { padding: 20px; }
            .options-grid { grid-template-columns: 1fr; }
            .nav-btn { font-size: 0.7rem; padding: 5px 10px; }
            .user-header { position: static; justify-content: center; margin-bottom: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1 class="app-title">üìö Little Lores</h1>
            <p class="app-subtitle">Discover the world through reading!</p>
            
            <!-- User Info (top right) -->
            <div id="userHeader" class="user-header hidden">
                <img id="userAvatar" class="user-avatar" src="" alt="User">
                <span id="userNameHeader"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            
            <!-- Navigation Menu -->
            <div id="navMenu" class="nav-menu hidden">
                <button class="nav-btn" onclick="showGradeSelect()">üìö Grade</button>
                <button class="nav-btn" onclick="showRegionSelect()">üó∫Ô∏è Region</button>
                <button class="nav-btn" onclick="showStoriesRead()">‚úÖ Read</button>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="card login-screen">
            <h2>Welcome, Young Explorer! üìö</h2>
            <p style="margin: 20px 0;">Let's start your reading adventure around the world!</p>
            <button class="google-login-btn" onclick="handleLogin()">
                <span>üîê</span> Login with Google
            </button>
            <div id="loginError" class="error hidden"></div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="card loading hidden">
            <h2>Loading your stories... üìñ</h2>
            <p>Please wait while we prepare your reading adventure!</p>
        </div>

        <!-- Grade Selection -->
        <div id="gradeScreen" class="card grade-selector hidden">
            <h2>What grade are you in? üéì</h2>
            <div class="options-grid">
                <button class="option-btn" onclick="selectGrade('K-1')">Kindergarten - 1st Grade</button>
                <button class="option-btn" onclick="selectGrade('2-3')">2nd - 3rd Grade</button>
                <button class="option-btn" onclick="selectGrade('4-5')">4th - 5th Grade</button>
                <button class="option-btn" onclick="selectGrade('6-8')">6th - 8th Grade</button>
            </div>
        </div>

        <!-- Region Selection -->
        <div id="regionScreen" class="card region-selector hidden">
            <div class="user-info">
                <p>Hello, <span id="userName">Student</span>! Grade: <span id="userGrade"></span></p>
            </div>
            <h2>Which part of the world would you like to explore? üó∫Ô∏è</h2>
            <div class="options-grid">
                <button class="option-btn" onclick="selectRegion('Africa')">üåç Africa</button>
                <button class="option-btn" onclick="selectRegion('Asia')">üèØ Asia</button>
                <button class="option-btn" onclick="selectRegion('Europe')">üè∞ Europe</button>
                <button class="option-btn" onclick="selectRegion('Americas')">üóΩ Americas</button>
                <button class="option-btn" onclick="selectRegion('Oceania')">üèùÔ∏è Oceania</button>
                <button class="option-btn" onclick="selectRegion('Mixed')">üåà Surprise Me!</button>
            </div>
        </div>

        <!-- Stories Selection -->
        <div id="storiesScreen" class="card hidden">
            <div class="user-info">
                <p><span id="userNameStories"></span> | Grade: <span id="userGradeStories"></span> | Region: <span id="userRegionStories"></span></p>
            </div>
            <h2>Choose your next adventure! üìñ</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p style="text-align: center; margin: 10px 0;">Stories completed: <span id="completedCount">0</span></p>
            <div class="stories-grid" id="storiesGrid">
                <!-- Stories will be loaded from Supabase -->
            </div>
            <div id="noStoriesMessage" class="hidden" style="text-align: center; padding: 40px;">
                <h3>üìö No new stories available!</h3>
                <p>You've read all the stories in this region. Try exploring a different region!</p>
            </div>
        </div>

        <!-- Stories Read Screen -->
        <div id="storiesReadScreen" class="card hidden">
            <h2>Stories You've Read! üéâ</h2>
            <div class="user-info" style="color: #333;">
                <p><span id="userNameRead"></span> | Grade: <span id="userGradeRead"></span></p>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFillRead" style="width: 0%"></div>
            </div>
            <p style="text-align: center; margin: 10px 0;">Stories completed: <span id="completedCountRead">0</span></p>
            
            <div id="completedStoriesGrid" class="stories-grid">
                <!-- Completed stories will be loaded from Supabase -->
            </div>
            
            <div id="noCompletedStories" class="hidden" style="text-align: center; padding: 40px;">
                <h3>üìñ No stories completed yet!</h3>
                <p>Start reading some amazing stories from around the world!</p>
                <button class="control-btn" onclick="backToStories()" style="margin-top: 15px;">Find Stories to Read</button>
            </div>
        </div>

        <!-- Reading View -->
        <div id="readingScreen" class="card hidden">
            <div class="reading-view">
                <div class="story-nation" id="currentStoryNation"></div>
                <h2 class="story-title" id="currentStoryTitle"></h2>
                
                <div class="reading-controls">
                    <button class="control-btn" onclick="toggleReadingAssist()">üí° Reading Help</button>
                    <button class="control-btn" id="audioBtn" onclick="toggleAudio()">üîä Read Aloud</button>
                    <button class="control-btn" id="stopBtn" onclick="stopAudio()" style="display: none;">‚èπÔ∏è Stop</button>
                    <button class="control-btn" onclick="adjustSpeed()">‚ö° Speed: <span id="speedDisplay">Normal</span></button>
                    <button class="control-btn" onclick="adjustTextSize()">üîç Text Size</button>
                </div>

                <div class="reading-assistance hidden" id="readingAssist">
                    <strong>Reading Tip:</strong> Click on highlighted words for help! Take your time and don't worry about reading perfectly.
                </div>

                <div class="story-text" id="currentStoryText"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="control-btn" onclick="completeStory()" style="background: #27ae60; font-size: 1.1rem; padding: 15px 30px;">
                        ‚úÖ I finished reading!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://mxjhvjwjgqmavmasfypa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14amh2andqZ3FtYXZtYXNmeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3Njk5NjEsImV4cCI6MjA2MDM0NTk2MX0.LLk01H7ueKFPMFpZfNOv3zx8VsICu6Gh6msuSjBW2x0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // App State
        let currentUser = null;
        let userGrade = null;
        let userRegion = null;
        let currentStory = null;
        let completedStories = new Set();
        let textSizeLevel = 1;
        let allStories = [];
        let userProfile = null;
        
        // Audio controls state
        let currentUtterance = null;
        let isReading = false;
        let isPaused = false;
        let speechRate = 0.8;

        // Screen navigation
        let currentScreen = 'loginScreen';
        const screenHistory = [];

        function showScreen(screenId) {
            // Stop audio when leaving reading screen
            if (currentScreen === 'readingScreen' && isReading) {
                stopAudio();
            }
            
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            
            if (screenId !== currentScreen) {
                screenHistory.push(currentScreen);
            }
            currentScreen = screenId;
        }

        function showLoading() {
            showScreen('loadingScreen');
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Authentication
        async function handleLogin() {
            try {
                showLoading();
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://ccalde29.github.io/LittleLoreApp/'
                    }
                });
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please try again.');
                showScreen('loginScreen');
            }
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                
                // Reset state
                currentUser = null;
                userGrade = null;
                userRegion = null;
                currentStory = null;
                completedStories.clear();
                textSizeLevel = 1;
                allStories = [];
                userProfile = null;
                
                // Reset audio
                if (isReading) stopAudio();
                
                document.getElementById('navMenu').classList.add('hidden');
                document.getElementById('userHeader').classList.add('hidden');
                screenHistory.length = 0;
                showScreen('loginScreen');
                
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Handle auth state changes - IMPROVED LOGIN FLOW
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state change:', event, session?.user?.email);
            
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                
                // Show user info and navigation
                document.getElementById('navMenu').classList.remove('hidden');
                document.getElementById('userHeader').classList.remove('hidden');
                document.getElementById('userNameHeader').textContent = currentUser.user_metadata.full_name || currentUser.email;
                document.getElementById('userAvatar').src = currentUser.user_metadata.avatar_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                
                // Load user profile
                await loadUserProfile();
                
                if (userProfile && userProfile.grade) {
                    // Remember last grade, go to region selection or stories
                    userGrade = userProfile.grade;
                    userRegion = userProfile.preferred_nation;
                    
                    // Update UI
                    document.getElementById('userName').textContent = currentUser.user_metadata.full_name || currentUser.email;
                    document.getElementById('userGrade').textContent = userGrade;
                    document.getElementById('userGradeStories').textContent = userGrade;
                    
                    if (userRegion) {
                        // Has both grade and region, go to stories
                        document.getElementById('userRegionStories').textContent = userRegion;
                        document.getElementById('userNameStories').textContent = currentUser.user_metadata.full_name || currentUser.email;
                        await loadStories();
                        await loadUserProgress();
                        showScreen('storiesScreen');
                    } else {
                        // Has grade but no region, go to region selection
                        showScreen('regionScreen');
                    }
                } else {
                    // First time user - go to grade selection
                    document.getElementById('userName').textContent = currentUser.user_metadata.full_name || currentUser.email;
                    showScreen('gradeScreen');
                }
            } else if (event === 'SIGNED_OUT') {
                // User logged out
                document.getElementById('userHeader').classList.add('hidden');
                showScreen('loginScreen');
            }
        });

        // User Profile Management
        async function loadUserProfile() {
            try {
                console.log('Loading profile for user:', currentUser.id);
                
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                console.log('Profile query result:', data, error);
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                userProfile = data;
                console.log('Loaded user profile:', userProfile);
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        async function saveUserProfile() {
            try {
                console.log('Saving profile:', { userGrade, userRegion });
                
                const profileData = {
                    user_id: currentUser.id,
                    grade: userGrade,
                    preferred_nation: userRegion,
                    onboarding_complete: true,
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('user_profiles')
                    .upsert(profileData, { 
                        onConflict: 'user_id',
                        ignoreDuplicates: false 
                    });
                
                console.log('Profile save result:', data, error);
                
                if (error) throw error;
                
                userProfile = { ...profileData };
                console.log('Profile saved successfully');
                
            } catch (error) {
                console.error('Error saving user profile:', error);
                alert('Failed to save profile. Please try again.');
            }
        }

        // Navigation functions
        function showGradeSelect() {
            showScreen('gradeScreen');
        }

        function showRegionSelect() {
            showScreen('regionScreen');
        }

        async function showStoriesRead() {
            await loadCompletedStories();
            showScreen('storiesReadScreen');
        }

        function backToStories() {
            if (userRegion) {
                showScreen('storiesScreen');
            } else {
                showScreen('regionScreen');
            }
        }

        // Grade and Region Selection
        async function selectGrade(grade) {
            userGrade = grade;
            document.getElementById('userGrade').textContent = grade;
            document.getElementById('userGradeStories').textContent = grade;
            
            document.querySelectorAll('#gradeScreen .option-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            setTimeout(() => showScreen('regionScreen'), 500);
        }

        async function selectRegion(region) {
            userRegion = region;
            document.getElementById('userRegionStories').textContent = region;
            document.getElementById('userNameStories').textContent = currentUser.user_metadata.full_name || currentUser.email;
            
            document.querySelectorAll('#regionScreen .option-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Save profile
            await saveUserProfile();
            
            setTimeout(async () => {
                showLoading();
                await loadStories();
                await loadUserProgress();
                showScreen('storiesScreen');
            }, 500);
        }

        // Story Management - IMPROVED WITH GRADE FILTERING
        async function loadStories() {
            try {
                console.log('Loading stories for region:', userRegion, 'grade:', userGrade);
                
                // Get appropriate grade levels (current + 1 above, except 6-8)
                const gradeOrder = ['K-1', '2-3', '4-5', '6-8'];
                const userIndex = gradeOrder.indexOf(userGrade);
                let allowedGrades = [userGrade];
                
                if (userIndex >= 0 && userIndex < gradeOrder.length - 1) {
                    allowedGrades.push(gradeOrder[userIndex + 1]); // +1 grade above
                }
                
                console.log('Allowed grades:', allowedGrades);
                
                let query = supabase
                    .from('stories_raw')
                    .select('*')
                    .in('grade_level', allowedGrades);
                
                if (userRegion && userRegion !== 'Mixed') {
                    query = query.eq('region', userRegion);
                }
                
                const { data, error } = await query;
                
                console.log('Stories query result:', data, error);
                
                if (error) throw error;
                
                allStories = data || [];
                console.log('Loaded stories:', allStories.length, 'for grades:', allowedGrades);
                displayStories();
                
            } catch (error) {
                console.error('Error loading stories:', error);
                showError('Failed to load stories. Please check your database connection.');
            }
        }

        function displayStories() {
            const storiesGrid = document.getElementById('storiesGrid');
            const noStoriesMessage = document.getElementById('noStoriesMessage');
            storiesGrid.innerHTML = '';
            
            // Filter out completed stories
            const unreadStories = allStories.filter(story => !completedStories.has(story.story_id));
            
            if (unreadStories.length === 0) {
                storiesGrid.style.display = 'none';
                noStoriesMessage.classList.remove('hidden');
                return;
            }
            
            storiesGrid.style.display = 'grid';
            noStoriesMessage.classList.add('hidden');
            
            // Show random selection of unread stories (max 5)
            const randomStories = shuffleArray(unreadStories).slice(0, 5);
            
            randomStories.forEach(story => {
                const storyCard = document.createElement('div');
                storyCard.className = 'story-card';
                storyCard.onclick = () => readStory(story);
                
                storyCard.innerHTML = `
                    <div class="story-nation">${story.nation}</div>
                    <div class="story-title">${story.title}</div>
                    <div class="story-preview">${story.text.substring(0, 100)}...</div>
                `;
                
                storiesGrid.appendChild(storyCard);
            });
            
            updateProgress();
        }

        async function loadUserProgress() {
            try {
                console.log('Loading user progress for:', currentUser.id);
                
                const { data, error } = await supabase
                    .from('user_progress')
                    .select('story_id')
                    .eq('user_id', currentUser.id)
                    .not('completed', 'is', null);
                
                console.log('Progress query result:', data, error);
                
                if (error) throw error;
                
                completedStories.clear();
                if (data) {
                    data.forEach(progress => {
                        completedStories.add(progress.story_id);
                    });
                }
                
                console.log('Completed stories:', Array.from(completedStories));
                
            } catch (error) {
                console.error('Error loading user progress:', error);
                completedStories.clear();
            }
        }

        async function loadCompletedStories() {
            const completedGrid = document.getElementById('completedStoriesGrid');
            const noStoriesMsg = document.getElementById('noCompletedStories');
            
            if (currentUser && userGrade) {
                document.getElementById('userNameRead').textContent = currentUser.user_metadata.full_name || currentUser.email;
                document.getElementById('userGradeRead').textContent = userGrade;
            }
            
            if (completedStories.size === 0) {
                completedGrid.style.display = 'none';
                noStoriesMsg.classList.remove('hidden');
                return;
            }
            
            completedGrid.style.display = 'grid';
            noStoriesMsg.classList.add('hidden');
            completedGrid.innerHTML = '';
            
            try {
                const completedIds = Array.from(completedStories);
                const { data, error } = await supabase
                    .from('stories_raw')
                    .select('*')
                    .in('story_id', completedIds);
                
                if (error) throw error;
                
                data.forEach(story => {
                    const storyCard = document.createElement('div');
                    storyCard.className = 'story-card completed';
                    storyCard.onclick = () => readStory(story);
                    
                    storyCard.innerHTML = `
                        <div class="story-nation">${story.nation}</div>
                        <div class="story-title">${story.title}</div>
                        <div class="story-preview">${story.text.substring(0, 100)}...</div>
                        <div style="margin-top: 10px; color: #27ae60; font-weight: bold;">‚úÖ Completed</div>
                    `;
                    
                    completedGrid.appendChild(storyCard);
                });
                
            } catch (error) {
                console.error('Error loading completed stories:', error);
            }
            
            updateProgressOnReadScreen();
        }

        // Reading Functions
        function readStory(story) {
            // Stop any current audio
            if (isReading) {
                stopAudio();
            }
            
            currentStory = story;
            document.getElementById('currentStoryNation').textContent = story.nation;
            document.getElementById('currentStoryTitle').textContent = story.title;
            document.getElementById('currentStoryText').innerHTML = addWordHelpers(story.text);
            showScreen('readingScreen');
        }

        // SMART WORD HIGHLIGHTING - LENGTH BASED
        function addWordHelpers(text) {
            if (!userGrade) return text;
            
            // Length thresholds by grade
            const lengthThresholds = {
                'K-1': 5,    // Words longer than 5 letters
                '2-3': 7,    // Words longer than 7 letters  
                '4-5': 8,    // Words longer than 8 letters
                '6-8': 10    // Words longer than 10 letters
            };
            
            const threshold = lengthThresholds[userGrade] || 8;
            
            // Split text into words and check each one
            const words = text.split(/(\s+)/); // Keep whitespace
            
            const processedWords = words.map(word => {
                // Only process actual words (not whitespace)
                const cleanWord = word.replace(/[^\w]/g, ''); // Remove punctuation for length check
                
                if (cleanWord.length > threshold && /^[a-zA-Z]+/.test(cleanWord)) {
                    // Highlight the word but preserve original punctuation
                    return word.replace(/\b[a-zA-Z]+\b/, match => 
                        `<span class="word-help" onclick="showWordHelp('${match.toLowerCase()}')" title="Click for help">${match}</span>`
                    );
                }
                return word;
            });
            
            return processedWords.join('');
        }

        function toggleReadingAssist() {
            document.getElementById('readingAssist').classList.toggle('hidden');
        }

        // FULL AUDIO CONTROLS
        function toggleAudio() {
            if (!('speechSynthesis' in window)) {
                alert('üîä Audio feature is not supported in your browser.');
                return;
            }

            if (isReading) {
                if (isPaused) {
                    // Resume
                    speechSynthesis.resume();
                    isPaused = false;
                    document.getElementById('audioBtn').innerHTML = '‚è∏Ô∏è Pause';
                } else {
                    // Pause
                    speechSynthesis.pause();
                    isPaused = true;
                    document.getElementById('audioBtn').innerHTML = '‚ñ∂Ô∏è Resume';
                }
            } else {
                // Start reading
                startAudio();
            }
        }

        function startAudio() {
            const text = document.getElementById('currentStoryText').textContent;
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = speechRate;
            
            currentUtterance.onstart = () => {
                isReading = true;
                isPaused = false;
                document.getElementById('audioBtn').innerHTML = '‚è∏Ô∏è Pause';
                document.getElementById('stopBtn').style.display = 'inline-block';
            };
            
            currentUtterance.onend = () => {
                resetAudioControls();
            };
            
            currentUtterance.onerror = () => {
                resetAudioControls();
                alert('Error with text-to-speech. Please try again.');
            };
            
            speechSynthesis.speak(currentUtterance);
        }

        function stopAudio() {
            speechSynthesis.cancel();
            resetAudioControls();
        }

        function resetAudioControls() {
            isReading = false;
            isPaused = false;
            currentUtterance = null;
            document.getElementById('audioBtn').innerHTML = 'üîä Read Aloud';
            document.getElementById('stopBtn').style.display = 'none';
        }

        function adjustSpeed() {
            const speeds = [0.5, 0.8, 1.0, 1.5, 2.0];
            const speedNames = ['Slow', 'Normal', 'Fast', 'Faster', 'Very Fast'];
            const currentIndex = speeds.indexOf(speechRate);
            const nextIndex = (currentIndex + 1) % speeds.length;
            
            speechRate = speeds[nextIndex];
            document.getElementById('speedDisplay').textContent = speedNames[nextIndex];
            
            // If currently reading, restart with new speed
            if (isReading && !isPaused) {
                const wasReading = true;
                stopAudio();
                if (wasReading) {
                    setTimeout(startAudio, 100);
                }
            }
        }

        function adjustTextSize() {
            textSizeLevel = textSizeLevel >= 3 ? 1 : textSizeLevel + 1;
            const sizes = ['1.2rem', '1.5rem', '1.8rem'];
            document.getElementById('currentStoryText').style.fontSize = sizes[textSizeLevel - 1];
        }

        function showWordHelp(word) {
            // Basic definitions for common complex words
            const definitions = {
                'magnificent': 'very beautiful and impressive',
                'cunning': 'clever in a sneaky way',
                'wisdom': 'knowledge and good judgment',
                'famine': 'when there is not enough food',
                'beautiful': 'very pretty or lovely',
                'disappeared': 'went away and could not be seen',
                'wonderful': 'very good and amazing',
                'ancient': 'very old, from long ago',
                'mysterious': 'hard to understand or explain',
                'adventure': 'an exciting experience or journey',
                'enormous': 'very very big',
                'dangerous': 'something that can hurt you',
                'incredible': 'amazing and hard to believe',
                'important': 'very special and needed',
                'different': 'not the same as something else',
                'together': 'at the same time or place',
                'remember': 'to think about something from before',
                'everywhere': 'in all places',
                'something': 'a thing, but we don\'t know what',
                'because': 'the reason why something happens'
            };
            
            const definition = definitions[word.toLowerCase()];
            
            if (definition) {
                alert(`üí° "${word}" means: ${definition}`);
            } else {
                // Generic help for words without definitions
                alert(`üí° "${word}" is a longer word that might be tricky. Sound it out slowly, or ask for help!`);
            }
        }

        async function completeStory() {
            if (!currentStory) return;
            
            try {
                console.log('Completing story:', currentStory.story_id);
                console.log('Current user ID:', currentUser.id);
                
                const progressData = {
                    user_id: currentUser.id,
                    story_id: currentStory.story_id,
                    completed: new Date().toISOString(),
                    completed_at: new Date().toISOString(),
                    last_read: new Date().toISOString()
                };
                
                console.log('Inserting progress data:', progressData);
                
                const { data, error } = await supabase
                    .from('user_progress')
                    .insert(progressData);
                
                console.log('Progress save result:', data, error);
                
                if (error) {
                    console.log('Insert failed, trying update...');
                    const { data: updateData, error: updateError } = await supabase
                        .from('user_progress')
                        .update({
                            completed: new Date().toISOString(),
                            completed_at: new Date().toISOString(),
                            last_read: new Date().toISOString()
                        })
                        .eq('user_id', currentUser.id)
                        .eq('story_id', currentStory.story_id);
                    
                    console.log('Update result:', updateData, updateError);
                    
                    if (updateError) throw updateError;
                }
                
                completedStories.add(currentStory.story_id);
                
                alert(`üéâ Great job reading "${currentStory.title}"! You're becoming a wonderful reader!`);
                
                await loadStories();
                showScreen('storiesScreen');
                
            } catch (error) {
                console.error('Error completing story:', error);
                completedStories.add(currentStory.story_id);
                alert('‚úÖ Story completed! (Saving failed, but progress recorded locally)');
                await loadStories();
                showScreen('storiesScreen');
            }
        }

        // Utility Functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function updateProgress() {
            const totalAvailable = allStories.length;
            const completed = completedStories.size;
            const percentage = totalAvailable > 0 ? (completed / totalAvailable) * 100 : 0;
            
            document.getElementById('progressFill').style.width = `${percentage}%`;
            document.getElementById('completedCount').textContent = completed;
        }

        function updateProgressOnReadScreen() {
            const totalAvailable = allStories.length;
            const completed = completedStories.size;
            const percentage = totalAvailable > 0 ? (completed / totalAvailable) * 100 : 0;
            
            document.getElementById('progressFillRead').style.width = `${percentage}%`;
            document.getElementById('completedCountRead').textContent = completed;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    // User is logged in, auth state change will handle the rest
                } else {
                    showScreen('loginScreen');
                }
            });
        });

        // Handle URL parameters (for OAuth redirect)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('error')) {
            showError('Login failed: ' + urlParams.get('error_description'));
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
</body>
</html>